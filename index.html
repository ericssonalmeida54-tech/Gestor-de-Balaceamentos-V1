<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Balanceamentos - DASS (Local)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
    </script>
    <script src="https://unpkg.com/lucide@0.292.0/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        .nav-link { transition: all 0.2s ease-in-out; border-left: 3px solid transparent; }
        .nav-link.active { background-color: #374151; border-left-color: #ef4444; }
        .loader { border: 4px solid #e5e7eb; border-radius: 50%; border-top: 4px solid #ef4444; width: 40px; height: 40px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        tbody tr:nth-child(even) { background-color: #f8fafc; }
        #app-container, #login-page, #public-view { display: none; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); transition: opacity 0.3s ease-in-out; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        #layout-viewer.edit-mode { cursor: crosshair; }
        .op-marker {
            position: absolute;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: rgba(239, 68, 68, 0.8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
        }
        .op-marker:hover { transform: translate(-50%, -50%) scale(1.1); background-color: rgba(219, 39, 39, 1); }

        .remove-marker-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background-color: #1f2937;
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #layout-viewer.edit-mode .op-marker:hover .remove-marker-btn {
            display: flex;
        }
        .remove-marker-btn:hover { background-color: #374151; }

        #unplaced-ops-list .op-item.selected-for-placement {
            background-color: #dbeafe;
            font-weight: bold;
            border-color: #3b82f6;
        }

        #flow-line-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }
        .flow-line {
            stroke: #6366f1;
            stroke-width: 3;
            fill: none;
            stroke-dasharray: 8 4;
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -12;
            }
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gray-100 p-4">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-lg">
            <div class="text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto" width="200" height="50" viewBox="0 0 200 50">
                    <text x="0" y="30" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="#ef4444">Dass</text>
                    <text x="0" y="45" font-family="Arial, sans-serif" font-size="7" font-weight="normal" fill="#94a3b8">IMPLEMENTING SPORTSWEAR BRANDS</text>
                </svg>
                <h2 class="mt-6 text-2xl font-bold text-gray-900">Acesse sua conta</h2>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email-input" class="text-sm font-bold text-gray-600 block">Usuário</label>
                    <input type="text" id="email-input" value="" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500" required>
                </div>
                <div>
                    <label for="password-input" class="text-sm font-bold text-gray-600 block">Senha</label>
                    <input type="password" id="password-input" value="" class="w-full p-2 mt-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-red-500" required>
                </div>
                <button type="submit" class="w-full py-2.5 px-4 text-sm font-semibold rounded-lg text-white bg-red-600 hover:bg-red-700">Entrar</button>
                <p id="login-error" class="text-sm text-red-600 text-center min-h-[20px]"></p>
            </form>
            <div class="text-center">
                <button id="public-access-btn" class="text-sm font-medium text-red-600 hover:text-red-800">Acessar Consulta Pública</button>
            </div>
        </div>
    </div>

    <div id="public-view" class="bg-gray-100 min-h-screen">
        <header class="bg-white shadow-md p-4 flex flex-col sm:flex-row justify-between items-center sticky top-0 z-10 gap-4 sm:gap-0">
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="150" height="40" viewBox="0 0 150 40">
                    <text x="0" y="25" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="#ef4444">Dass</text>
                    <text x="0" y="35" font-family="Arial, sans-serif" font-size="6" font-weight="normal" fill="#94a3b8">IMPLEMENTING SPORTSWEAR BRANDS</text>
                </svg>
                <span class="text-lg font-semibold text-slate-700">Modo de Consulta</span>
            </div>
            <button id="go-to-login-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold w-full sm:w-auto">Login de Administrador</button>
        </header>
        <div class="p-4 md:p-8">
            <div id="public-content">
                </div>
        </div>
    </div>

    <div id="app-container" class="flex h-screen overflow-hidden">
        <aside id="sidebar" class="w-64 bg-gray-900 text-white flex-col p-4 flex absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30">
            <div class="flex items-center justify-center gap-3 text-center py-4 border-b border-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="200" height="50" viewBox="0 0 200 50">
                    <text x="0" y="30" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="#ef4444">Dass</text>
                    <text x="0" y="45" font-family="Arial, sans-serif" font-size="7" font-weight="normal" fill="#cbd5e1">IMPLEMENTING SPORTSWEAR BRANDS</text>
                </svg>
            </div>
            <nav id="main-nav" class="mt-8 flex-grow">
                <button id="nav-home" class="nav-link w-full text-left flex items-center gap-3 font-semibold py-3 px-4 rounded-lg active"><i data-lucide="layout-dashboard" class="w-5 h-5"></i>Painel</button>
                <button id="nav-analytics" class="nav-link w-full text-left flex items-center gap-3 font-semibold py-3 px-4 rounded-lg"><i data-lucide="pie-chart" class="w-5 h-5"></i>Análises</button>
                <button id="nav-processes" class="nav-link w-full text-left flex items-center gap-3 font-semibold py-3 px-4 rounded-lg"><i data-lucide="folder-kanban" class="w-5 h-5"></i>Balanceamentos</button>
                <button id="nav-admin" class="nav-link w-full text-left flex items-center gap-3 font-semibold py-3 px-4 rounded-lg"><i data-lucide="shield-check" class="w-5 h-5"></i>Administrador</button>
            </nav>
            <div id="user-session" class="mt-auto border-t border-gray-700 pt-4">
                <div id="user-info">
                    <p id="user-email" class="text-sm font-medium text-slate-200 truncate"></p>
                    <p id="user-role" class="text-xs text-slate-400 capitalize"></p>
                </div>
                <button id="logout-btn" class="w-full mt-4 text-left flex items-center gap-3 text-slate-300 hover:text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-800/50"><i data-lucide="log-out" class="w-5 h-5"></i>Sair</button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm p-2 md:hidden flex items-center">
                 <button id="mobile-menu-btn" class="p-2 text-gray-600 rounded-md hover:bg-gray-100">
                      <i data-lucide="menu" class="w-6 h-6"></i>
                 </button>
            </header>
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
                <div id="page-home">
                    <div class="mb-8">
                        <h2 class="text-2xl sm:text-3xl font-bold mb-4">Painel Geral</h2>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 space-y-8">
                            <section id="admin-section" class="space-y-4 p-4 sm:p-6 bg-white rounded-xl shadow-sm border">
                                <div class="flex items-center gap-3"><i data-lucide="upload-cloud" class="text-red-500"></i><h2 class="text-xl font-semibold">Carregar Novo Balanceamento</h2></div>
                                <p class="text-sm text-slate-600">O sistema extrairá os detalhes do arquivo CSV e usará a marca selecionada abaixo.</p>

                                <div class="space-y-4">
                                    <div>
                                        <label for="celula-input" class="block text-sm font-medium text-slate-600 mb-1">Célula/Setor *</label>
                                        <input type="text" id="celula-input" placeholder="Ex: Costura / Célula 10" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm">
                                    </div>
                                    <div>
                                        <label for="brand-input" class="block text-sm font-medium text-slate-600 mb-1">Marca *</label>
                                        <select id="brand-input" class="w-full p-2 border bg-white border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 text-sm">
                                            <option value="Nike">Nike</option>
                                            <option value="Fila">Fila</option>
                                            <option value="Osklen">Osklen</option>
                                            <option value="Outra">Outra</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="csv-upload" class="block text-sm font-medium text-slate-600 mb-1">Arquivo de Balanceamento (CSV) *</label>
                                        <input type="file" id="csv-upload" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100 cursor-pointer"/>
                                    </div>
                                </div>

                                <button id="process-file-btn" class="w-full bg-red-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-red-700 transition duration-300 flex items-center justify-center gap-2"><i data-lucide="cog"></i> Processar Arquivo</button>
                                <div id="file-status" class="text-center mt-2 text-sm min-h-[40px]"></div>
                            </section>
                            <section id="operator-consult-section" class="space-y-4 p-4 sm:p-6 bg-white rounded-xl shadow-sm border">
                                <div class="flex items-center gap-3"><i data-lucide="user-search" class="text-red-500"></i><h2 class="text-xl font-semibold">Consultar Operador</h2></div>
                                <p class="text-sm text-slate-600">Use o leitor para consultar as operações de um colaborador.</p>
                                <input type="text" id="operator-badge-consult-input" placeholder="Aguardando crachá do operador..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition">
                            </section>
                        </div>
                        <div class="lg:col-span-2">
                            <div id="result-card" class="p-4 sm:p-6 bg-white rounded-xl shadow-sm border min-h-[500px] flex flex-col h-full">
                                <div id="home-loader" class="hidden m-auto loader"></div>
                                <div id="welcome-message" class="text-center text-slate-400 m-auto p-4"><i data-lucide="layout-grid" class="mx-auto h-16 w-16 mb-4 stroke-1"></i><h3 class="text-lg font-medium">Área de Resultados</h3><p>Os detalhes do balanceamento ou da operação consultada serão exibidos aqui.</p></div>
                                <div id="error-message" class="hidden text-center text-red-500 font-medium m-auto"><i data-lucide="x-circle" class="mx-auto h-12 w-12 mb-2"></i><p id="error-text">Operação não encontrada.</p></div>

                                <div id="process-view-container" class="hidden flex-1 flex-col h-full">
                                    <div id="process-header-block" class="mb-4 p-4 bg-slate-50 rounded-lg border"></div>

                                    <div id="operations-list-actions" class="flex flex-wrap justify-end mb-4 gap-2">
                                        <div id="process-action-buttons" class="flex flex-wrap gap-2">
                                            <button id="manage-all-teams-btn" class="hidden bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2 text-sm">
                                                <i data-lucide="users" class="w-5 h-5"></i>Gerir Todas as Equipes
                                            </button>
                                            <button id="approve-process-btn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 flex items-center justify-center gap-2 text-sm"><i data-lucide="check-circle-2" class="w-5 h-5"></i>Aprovar</button>
                                            <button id="reject-process-btn" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 flex items-center justify-center gap-2 text-sm"><i data-lucide="x-circle" class="w-5 h-5"></i>Reprovar</button>
                                            <button id="delete-process-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center justify-center gap-2 text-sm"><i data-lucide="trash-2" class="w-5 h-5"></i>Excluir</button>
                                        </div>
                                    </div>

                                    <div id="operations-list-container" class="flex-1 overflow-y-auto">
                                        <div class="border rounded-lg overflow-x-auto">
                                            <table class="min-w-full">
                                                <thead class="bg-slate-50 sticky top-0 z-10">
                                                    <tr>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Descrição</th>
                                                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Eficiência</th>
                                                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Tempo</th>
                                                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">OP.</th>
                                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Equipamento/Máquina</th>
                                                        <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="operations-table-body" class="bg-white divide-y divide-slate-200"></tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div id="result-content" class="hidden space-y-8">
                                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                            <div><h4 class="text-lg font-semibold text-red-700" id="result-id"></h4><p class="text-2xl sm:text-3xl font-bold mt-1" id="result-description"></p></div>
                                            <button id="back-to-list-btn" class="bg-slate-200 text-slate-700 font-bold py-2 px-3 rounded-lg hover:bg-slate-300 transition duration-300 flex items-center gap-2 w-full sm:w-auto justify-center"><i data-lucide="arrow-left" class="w-5 h-5"></i> Voltar</button>
                                        </div>
                                        <div class="mt-6 pt-6 border-t"><dl class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-6">
                                            <div><dt class="text-sm font-medium text-slate-500">Carregado por</dt><dd class="mt-1 text-base font-semibold text-slate-900" id="result-owner-email"></dd></div>
                                            <div><dt class="text-sm font-medium text-slate-500">Data de Carregamento</dt><dd class="mt-1 text-base font-semibold text-slate-900" id="result-creation-date"></dd></div>
                                            <div><dt class="text-sm font-medium text-slate-500">Máquina / Seção</dt><dd class="mt-1 text-base font-semibold text-slate-900" id="result-machine"></dd></div>
                                            <div><dt class="text-sm font-medium text-slate-500">Sequência</dt><dd class="mt-1 text-base font-semibold text-slate-900 font-mono" id="result-sequence"></dd></div>
                                            <div><dt class="text-sm font-medium text-slate-500">Operadores (Reais)</dt><dd class="mt-1 text-base font-semibold text-slate-900 font-mono" id="result-operators-real"></dd></div>
                                            <div><dt class="text-sm font-medium text-slate-500">Tempo (Centesimal)</dt><dd class="mt-1 text-base font-semibold text-slate-900 font-mono" id="result-time-centesimal"></dd></div>
                                            <div><dt class="text-sm font-medium text-slate-500">Tempo (Segundos)</dt><dd class="mt-1 text-base font-semibold text-slate-900 font-mono" id="result-time-seconds"></dd></div><div class="lg:col-span-3 bg-slate-50 p-4 rounded-lg text-center"><dt class="text-sm font-medium text-slate-500">Eficiência Calculada</dt><dd class="mt-1 text-3xl sm:text-4xl font-bold font-mono" id="result-efficiency"></dd></div></dl></div>
                                        <div id="observation-section" class="pt-6 border-t"><h4 class="text-lg font-semibold">Observação da Operação</h4><textarea id="observation-text" class="w-full mt-2 p-2 border border-slate-300 rounded-md h-24 focus:ring-2 focus:ring-red-500" placeholder="Adicione uma observação a esta operação..."></textarea><button id="save-observation-btn" class="mt-2 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center gap-2"><i data-lucide="save" class="w-5 h-5"></i> Salvar</button><p id="observation-status" class="text-sm mt-2 min-h-[20px]"></p></div>
                                        <div id="team-section" class="pt-6 border-t"><h4 class="text-lg font-semibold">Equipe</h4><p class="text-sm text-slate-600 mb-3" id="operator-count-status-detail"></p><div id="assigned-operators-list-detail" class="space-y-2 mb-4"></div><button id="manage-team-from-detail-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center gap-2"><i data-lucide="users" class="w-5 h-5"></i>Gerir Equipe</button></div>
                                    </div>

                                    <div id="operator-consult-results-container" class="hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-analytics" class="hidden">
                    </div>

                <div id="page-processes" class="hidden">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">Balanceamentos</h2>

                    <div class="mb-6">
                        <input type="text" id="processes-search-input" placeholder="Buscar por nome ou célula..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500">
                    </div>

                    <div id="processes-loader" class="hidden mx-auto loader mt-10"></div>
                    <div id="processes-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                    <div id="no-processes-message" class="hidden text-center text-slate-500 mt-10 p-4"><i data-lucide="folder-x" class="mx-auto h-16 w-16 mb-4 stroke-1"></i><h3 class="text-lg font-medium">Nenhum balanceamento encontrado.</h3><p>Carregue um arquivo na página inicial para começar.</p></div>
                </div>

                <div id="page-admin" class="hidden">
                    <h2 class="text-2xl sm:text-3xl font-bold mb-6">Administração de Usuários</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <form id="create-user-form" class="p-4 sm:p-6 bg-white rounded-xl shadow-sm border space-y-4">
                                <h3 class="text-xl font-semibold">Criar Novo Usuário</h3>
                                <div><label for="new-user-name" class="block text-sm font-medium text-slate-600">Nome</label><input type="text" id="new-user-name" class="mt-1 w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" required></div>
                                <div><label for="new-user-email" class="block text-sm font-medium text-slate-600">Usuário (login)</label><input type="text" id="new-user-email" class="mt-1 w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" required></div>
                                <div><label for="new-user-password" class="block text-sm font-medium text-slate-600">Senha</label><input type="password" id="new-user-password" class="mt-1 w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" required></div>
                                <div><label for="new-user-role" class="block text-sm font-medium text-slate-600">Cargo</label><select id="new-user-role" class="mt-1 w-full p-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500"><option value="publico">Público</option><option value="lideranca">Liderança</option><option value="analista">Analista</option><option value="gerente">Gerente</option><option value="admin">Administrador</option></select></div>
                                <button type="submit" class="w-full bg-red-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-red-700">Criar Usuário</button>
                                <p id="create-user-status" class="text-sm text-center min-h-[20px]"></p>
                            </form>
                        </div>
                        <div class="lg:col-span-2">
                            <div class="p-4 sm:p-6 bg-white rounded-xl shadow-sm border">
                                <h3 class="text-xl font-semibold mb-4">Usuários do Sistema</h3>
                                <div id="users-list-loader" class="hidden mx-auto loader"></div>
                                <div class="overflow-x-auto max-h-[500px]"><table class="min-w-full"><thead class="bg-slate-50 sticky top-0"><tr><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nome</th><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Usuário</th><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Cargo</th><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Ações</th></tr></thead><tbody id="users-list-body" class="divide-y divide-slate-200"></tbody></table></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="delete-confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-lg">
            <h3 id="delete-modal-title" class="text-lg font-bold">Confirmar Ação</h3>
            <p id="delete-modal-text" class="mt-2 text-sm text-slate-600">Tem certeza?</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="manage-team-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-lg p-6 rounded-2xl shadow-lg flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-lg font-bold">Gerir Equipe da Operação</h3>
                    <p id="manage-team-modal-op-info" class="text-sm text-slate-500 mt-1"></p>
                </div>
                <button id="close-manage-team-modal-btn" class="p-1 rounded-full text-slate-500 hover:bg-red-100 hover:text-red-700 transition-colors"> <i data-lucide="x" class="w-6 h-6"></i> </button>
            </div>
            <div class="mt-4 border-t pt-4">
                <label for="add-operator-by-badge-input" class="block text-sm font-medium text-slate-600">Adicionar Operador (leitura de crachá)</label>
                <input type="text" id="add-operator-by-badge-input" placeholder="Aguardando crachá..." class="mt-1 w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500">
                <p id="add-operator-status" class="text-sm mt-2 min-h-[20px]"></p>
            </div>
            <div class="mt-4 border-t pt-4 flex-grow overflow-y-auto min-h-[100px]">
                <p id="manage-team-count-status" class="text-sm font-medium text-slate-600 mb-3"></p>
                <div id="manage-team-list" class="space-y-2">
                </div>
            </div>
            <div class="mt-6 pt-4 border-t flex justify-end">
                <button id="done-manage-team-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center gap-2"> <i data-lucide="check-square" class="w-5 h-5"></i>Concluir</button>
            </div>
        </div>
    </div>

    <div id="batch-team-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-2xl p-6 rounded-2xl shadow-lg flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-lg font-bold">Gerenciamento de Equipe em Lote</h3>
                    <p id="batch-modal-process-info" class="text-sm text-slate-500 mt-1"></p>
                </div>
                <button id="close-batch-modal-btn" class="p-1 rounded-full text-slate-500 hover:bg-red-100 hover:text-red-700 transition-colors"> <i data-lucide="x" class="w-6 h-6"></i> </button>
            </div>
            <div class="flex-grow overflow-y-auto min-h-[100px] space-y-4">
                <div id="batch-op-details" class="p-4 bg-slate-50 rounded-lg border">
                    <p class="font-bold text-red-600" id="batch-op-sequence">Seq: -</p>
                    <p class="text-xl font-semibold" id="batch-op-description">Operação:</p>
                    <p class="text-sm text-slate-600 mt-1">Operadores Necessários: <span class="font-semibold" id="batch-op-required"></span></p>
                    <p class="text-sm text-slate-600 mt-1">Operadores Vinculados: <span class="font-semibold" id="batch-op-current"></span></p>
                </div>
                <div class="space-y-2">
                    <label for="batch-add-operator-input" class="block text-sm font-medium text-slate-600">Adicionar Operador (leitura de crachá)</label>
                    <input type="text" id="batch-add-operator-input" placeholder="Aguardando crachá..." class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500">
                    <p id="batch-add-operator-status" class="text-sm min-h-[20px]"></p>
                </div>
                <div>
                    <h4 class="font-semibold text-slate-700 mb-2">Equipe da Operação Atual</h4>
                    <div id="batch-team-list" class="space-y-2"></div>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t flex justify-between gap-3">
                <button id="batch-previous-btn" class="bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 flex items-center gap-2"><i data-lucide="arrow-left" class="w-5 h-5"></i> Anterior</button>
                <div class="flex gap-3">
                     <button id="batch-skip-btn" class="bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 flex items-center gap-2">Pular <i data-lucide="arrow-right" class="w-5 h-5"></i></button>
                     <button id="batch-next-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center gap-2">Próximo <i data-lucide="check" class="w-5 h-5"></i></button>
                </div>
                <button id="batch-finish-btn" class="hidden bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center gap-2"><i data-lucide="check-square" class="w-5 h-5"></i> Concluir</button>
            </div>
        </div>
    </div>

    <div id="edit-user-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-lg">
            <form id="edit-user-form">
                <h3 class="text-lg font-bold">Editar Usuário</h3>
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="edit-user-name" class="block text-sm font-medium text-slate-600">Nome</label>
                        <input type="text" id="edit-user-name" class="mt-1 w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500" required>
                    </div>
                    <div>
                        <label for="edit-user-email" class="block text-sm font-medium text-slate-600">Usuário (não pode ser alterado)</label>
                        <input type="text" id="edit-user-email" class="mt-1 w-full p-2 border border-slate-300 rounded-lg bg-slate-100" disabled>
                    </div>
                    <div>
                        <label for="edit-user-role" class="block text-sm font-medium text-slate-600">Cargo</label>
                        <select id="edit-user-role" class="mt-1 w-full p-2 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500">
                            <option value="publico">Público</option>
                            <option value="lideranca">Liderança</option>
                            <option value="analista">Analista</option>
                            <option value="gerente">Gerente</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <p id="edit-user-status" class="text-sm text-center min-h-[20px]"></p>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-edit-user-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <div id="custom-alert-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-lg text-center">
            <h3 id="custom-alert-title" class="text-lg font-bold text-slate-800">Aviso</h3>
            <p id="custom-alert-text" class="mt-2 text-sm text-slate-600">Mensagem de alerta.</p>
            <div class="mt-6 flex justify-center">
                <button id="custom-alert-ok-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">OK</button>
            </div>
        </div>
    </div>

    <div id="overstaff-justification-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-lg">
            <h3 class="text-lg font-bold">Justificar Excesso de Pessoal</h3>
            <p id="overstaff-modal-text" class="mt-2 text-sm text-slate-600">A operação já atingiu o número necessário de operadores. Por favor, justifique a adição de um operador extra.</p>
            <div class="mt-4">
                <textarea id="overstaff-reason-input" class="w-full mt-2 p-2 border border-slate-300 rounded-md h-24 focus:ring-2 focus:ring-red-500" placeholder="Digite o motivo aqui..."></textarea>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancel-overstaff-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Cancelar</button>
                <button id="confirm-overstaff-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirmar Adição</button>
            </div>
        </div>
    </div>

    <div id="layout-modal" class="fixed inset-0 z-40 hidden flex-col bg-white modal-backdrop">
        <header class="p-4 bg-slate-800 text-white flex justify-between items-center shadow-md flex-wrap gap-2">
            <h3 id="layout-modal-title" class="text-lg font-bold">Layout da Célula</h3>
            <div id="layout-modal-controls" class="flex items-center gap-4 flex-wrap">
                 <div id="heatmap-legend" class="hidden items-center gap-3 text-xs">
                    <span class="font-bold">Legenda:</span>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-red-500 border border-white"></div>Gargalo (&gt;100%)</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-green-500 border border-white"></div>Bom (80-100%)</div>
                    <div class="flex items-center gap-1"><div class="w-3 h-3 rounded-full bg-amber-500 border border-white"></div>Ociosa (&lt;80%)</div>
                 </div>

                 <button id="rotate-layout-btn" class="p-2 text-white hover:bg-white/10 rounded-full" title="Rotacionar Layout">
                    <i data-lucide="rotate-cw" class="w-5 h-5"></i>
                 </button>

                 <label class="flex items-center gap-2 cursor-pointer text-sm font-medium">
                       <span>Mostrar Fluxo</span>
                       <div class="relative">
                            <input type="checkbox" id="show-flow-toggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                       </div>
                 </label>
                 <label class="flex items-center gap-2 cursor-pointer text-sm font-medium">
                       <span>Ver Gargalos</span>
                       <div class="relative">
                            <input type="checkbox" id="show-heatmap-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div>
                       </div>
                 </label>
                <div id="edit-layout-controls" class="hidden items-center gap-2">
                    <label class="flex items-center gap-2 cursor-pointer text-sm font-medium">
                        <span>Modo Edição</span>
                        <div class="relative">
                            <input type="checkbox" id="edit-layout-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                        </div>
                    </label>
                    <button id="save-layout-btn" class="hidden bg-green-600 text-white font-bold py-1.5 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 text-sm">
                        <i data-lucide="save" class="w-4 h-4"></i> Salvar
                    </button>
                </div>
                <button id="close-layout-modal-btn" class="p-1 rounded-full hover:bg-red-100/20 transition-colors">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
        </header>
        <div class="flex flex-1 overflow-hidden flex-col md:flex-row">
            <aside id="layout-editor-sidebar" class="w-full md:w-80 bg-slate-50 border-r p-4 flex-col overflow-y-auto hidden">
                <div class="space-y-4">
                    <div id="layout-upload-section" class="space-y-4">
                        <div class="p-4 border border-dashed rounded-lg text-center">
                            <label for="layout-pdf-upload" class="cursor-pointer">
                                <i data-lucide="layout-template" class="w-10 h-10 mx-auto text-slate-400"></i>
                                <p class="mt-2 text-sm font-semibold text-slate-700">Carregar/Alterar Layout (PDF)</p>
                                <p class="text-xs text-slate-500">Arraste ou clique para selecionar</p>
                            </label>
                            <input type="file" id="layout-pdf-upload" accept=".pdf" class="hidden"/>
                            <p id="layout-upload-status" class="text-xs mt-2 min-h-[16px]"></p>
                        </div>
                        <div class="p-4 border border-dashed rounded-lg text-center">
                            <div class="flex justify-center items-center gap-2">
                                <label for="process-pdf-upload" class="cursor-pointer flex-1">
                                    <i data-lucide="file-text" class="w-10 h-10 mx-auto text-slate-400"></i>
                                    <p class="mt-2 text-sm font-semibold text-slate-700">Carregar/Alterar PDF do Balanceamento</p>
                                </label>
                                <button id="view-process-pdf-btn" class="p-2 text-blue-600 hover:bg-blue-100 rounded-full" title="Visualizar PDF do Balanceamento">
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <input type="file" id="process-pdf-upload" accept=".pdf" class="hidden"/>
                            <p id="process-pdf-upload-status" class="text-xs mt-2 min-h-[16px]"></p>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-slate-800">Operações Não Posicionadas</h4>
                            <button id="remove-all-markers-btn" title="Remover Todos os Marcadores" class="p-2 text-red-600 hover:bg-red-100 rounded-full">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                            <p>Selecione uma operação abaixo e clique no layout para posicioná-la.</p>
                        </div>
                        <div id="unplaced-ops-list" class="space-y-2 text-sm mt-3 max-h-96 overflow-y-auto pr-2">
                            </div>
                    </div>
                </div>
            </aside>
            <main class="flex-1 bg-slate-200 flex items-center justify-center p-4 overflow-auto" id="layout-main-container">
                <div id="layout-placeholder" class="hidden text-center text-slate-500">
                    <i data-lucide="image-off" class="w-24 h-24 mx-auto stroke-1"></i>
                    <h3 class="mt-4 text-xl font-semibold">Nenhum Layout Carregado</h3>
                    <p class="mt-1">Use o menu de edição para carregar um arquivo PDF do layout.</p>
                </div>
                <div id="layout-viewer" class="relative shadow-lg bg-white">
                    <canvas id="layout-canvas"></canvas>
                    <div id="marker-container" class="absolute inset-0">
                        <svg id="flow-line-svg" width="100%" height="100%"></svg>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="operation-tooltip" class="hidden absolute z-50 p-3 bg-slate-900 text-white text-sm rounded-lg shadow-xl max-w-xs"></div>

    <script>
        // =========================================================================================
        // ||||||||||||||||||||||||||| INÍCIO DO CÓDIGO MODIFICADO |||||||||||||||||||||||||||||||
        // =========================================================================================

        // --- Constantes da API ---
        const API_URL = 'api.php';
        const UPLOAD_URL = 'upload.php';

        // --- Estado Global ---
        let lastProcessedOperations = []; // Dados "oficiais" do banco
        let allProcessesMap = new Map(); // Cache para a página de Balanceamentos
        let currentOperation = null;
        let currentProcessModelName = null;
        let deleteContext = { type: null, id: null, name: null, onConfirm: null };
        let currentUser = null;
        let editingUserId = null;
        let selectedOpToPlace = null;
        let currentLayoutUrl = null;
        let batchTeamOps = [];
        let batchTeamIndex = 0;
        let justificationContext = { badgeId: null, op: null, isBatch: false, reason: '' };

        // Estado local para o editor de layout
        let layoutEditorOps = [];
        let layoutHasChanges = false;
        let currentRotation = 0; // Para rotação do PDF

        let chartInstances = {};

        // Mapeia todos os elementos com ID para um objeto `ui`
        const ui = Object.fromEntries(
            Array.from(document.querySelectorAll('[id]')).map(el => [el.id.replace(/-./g, c => c.substring(1).toUpperCase()), el])
        );

        // --- Funções Auxiliares da API ---
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, options);
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error("Erro de API (não-JSON):", text);
                    throw new Error(`O servidor respondeu com um erro inesperado. Verifique os logs do PHP/Apache. Detalhe: ${text.substring(0, 150)}...`);
                }

                if (!response.ok) {
                    throw new Error(data.message || `Erro de rede: ${response.statusText}`);
                }

                if (data.status === 'error' && data.message) {
                    console.error('Erro da API:', data.message);
                }
                return data;
            } catch (error) {
                console.error('Erro na requisição:', error);
                let msg = 'Falha de comunicação com o servidor. Verifique se o XAMPP (Apache, MySQL) está rodando.';
                if (error.message.includes("inesperado") || error.message.includes("rede")) {
                    msg = error.message;
                }
                showCustomAlert(msg, "Erro de Conexão");
                return { status: 'error', message: error.message };
            }
        }

        function getSanitizedModelName(modelName) {
            if (!modelName) return '';
            return modelName.replace(/[^a-zA-Z0-9_.-]/g, '');
        }

        // --- Funções de Controle da UI ---
        const showView = (viewName) => {
            ['loginPage', 'appContainer', 'publicView'].forEach(v => {
                if(ui[v]) ui[v].style.display = 'none'
            });
            if (ui[viewName]) {
                ui[viewName].style.display = (viewName === 'loginPage' || viewName === 'appContainer' || viewName === 'layoutModal') ? 'flex' : 'block';
            }
        };

        const showPage = (pageId) => {
            ['pageHome', 'pageProcesses', 'pageAdmin', 'pageAnalytics'].forEach(p => ui[p] && (ui[p].style.display = 'none'));
            document.querySelectorAll('#main-nav .nav-link').forEach(n => n.classList.remove('active'));

            if (ui[pageId]) ui[pageId].style.display = 'block';
            const navId = pageId.replace('page', 'nav');
            if (ui[navId]) ui[navId].classList.add('active');

            // Limpa o estado da página inicial ao navegar para outra página
            if (pageId !== 'pageHome') {
                showHomeState('welcome');
            }

            if (pageId === 'pageHome') fetchAndRenderDashboard();
            if (pageId === 'pageProcesses') renderProcessesPage();
            if (pageId === 'pageAdmin') renderAdminPage();
            if (pageId === 'pageAnalytics') renderAnalyticsPage();

            if (ui.sidebar) ui.sidebar.classList.add('-translate-x-full');
        };

        const showHomeState = (state, text = '') => {
            ['homeLoader', 'welcomeMessage', 'errorMessage', 'processViewContainer', 'operatorConsultResultsContainer'].forEach(el => ui[el] && (ui[el].style.display = 'none'));
            if (state === 'loading') {
                ui.homeLoader.style.display = 'block';
            } else if (state === 'welcome') {
                ui.welcomeMessage.style.display = 'block';
            } else if (state === 'error') {
                ui.errorText.textContent = text;
                ui.errorMessage.style.display = 'block';
            } else if (state === 'process') {
                ui.processViewContainer.style.display = 'flex';
            } else if (state === 'operatorConsult') {
                ui.operatorConsultResultsContainer.style.display = 'block';
            }
        };

        const updateUIForPermissions = () => {
            const role = currentUser?.role || 'publico';
            const can = (allowedRoles) => allowedRoles.includes(role);

            ui.navAdmin.style.display = can(['admin']) ? 'flex' : 'none';
            ui.navAnalytics.style.display = can(['admin', 'gerente']) ? 'flex' : 'none';
            ui.navProcesses.style.display = can(['admin', 'gerente', 'analista', 'lideranca']) ? 'flex' : 'none';

            ui.adminSection.style.display = can(['admin', 'gerente', 'analista']) ? 'block' : 'none';

            if (ui.approveProcessBtn) ui.approveProcessBtn.style.display = can(['admin', 'gerente']) ? 'flex' : 'none';
            if (ui.rejectProcessBtn) ui.rejectProcessBtn.style.display = can(['admin', 'gerente']) ? 'flex' : 'none';
            if (ui.deleteProcessBtn) ui.deleteProcessBtn.style.display = can(['admin', 'gerente']) ? 'flex' : 'none';

            if (ui.manageAllTeamsBtn) ui.manageAllTeamsBtn.style.display = can(['lideranca', 'admin', 'gerente']) ? 'flex' : 'none';

            document.querySelectorAll('.manage-team-btn, #manage-team-from-detail-btn').forEach(el => {
                el.style.display = can(['admin', 'gerente', 'lideranca']) ? 'flex' : 'none';
            });

            if(ui.observationSection) ui.observationSection.style.display = can(['admin', 'gerente', 'analista']) ? 'block' : 'none';

            if (ui.manageLayoutBtn) ui.manageLayoutBtn.style.display = can(['admin', 'gerente', 'analista', 'lideranca']) ? 'flex' : 'none';
            if (ui.editLayoutControls) ui.editLayoutControls.style.display = can(['admin', 'gerente', 'analista']) ? 'flex' : 'none';
        };

        const showModal = (modalId, show = true) => {
            const modal = ui[modalId];
            if (modal) {
                modal.style.display = show ? 'flex' : 'none';
            }
        };

        const showCustomAlert = (message, title = "Aviso") => {
            ui.customAlertTitle.textContent = title;
            ui.customAlertText.textContent = message;
            showModal('customAlertModal');
        };

        // --- Funções de Autenticação ---
        const handleLogin = async (e) => {
            e.preventDefault();
            ui.loginError.textContent = '';
            const username = ui.emailInput.value;
            const password = ui.passwordInput.value;

            const response = await apiRequest(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'login', username, password })
            });

            if (response.status === 'success') {
                sessionStorage.setItem('currentUser', JSON.stringify(response.user));
                checkAuthState();
            } else {
                ui.loginError.textContent = response.message || "Usuário ou senha inválidos.";
            }
        };

        const handleLogout = () => {
            sessionStorage.removeItem('currentUser');
            currentUser = null;
            allProcessesMap.clear();
            showView('loginPage');
        };

        const checkAuthState = () => {
            const userJSON = sessionStorage.getItem('currentUser');
            if (userJSON) {
                currentUser = JSON.parse(userJSON);
                ui.userEmail.textContent = currentUser.name || currentUser.username;
                ui.userRole.textContent = currentUser.role;
                showView('appContainer');
                showPage('pageHome');
            } else {
                currentUser = null;
                showView('loginPage');
            }
            updateUIForPermissions();
            lucide.createIcons();
        };

        // --- Funções de Renderização (Público) ---
        const renderPublicProcessDetails = (modelName, operations) => {
            // CORRIGIDO: Garante que o modal de layout não esteja aberto por engano
            showModal('layoutModal', false);
            
            const publicContent = ui.publicContent;
            if (!publicContent) return;
            const firstOp = operations[0];
            const metrics = calculateOverallProcessMetrics(operations);
            operations.sort((a, b) => parseInt(a.sequence) - parseInt(b.sequence));

            const tableRows = operations.map(op => {
                const { value, colorClass } = calculateEfficiency(op);
                const operatorsHtml = op.assignedOperators && op.assignedOperators.length > 0
                    ? op.assignedOperators.map(o => `<span class="block whitespace-nowrap">${o.name} - Ranking: ${o.ranking || 'N/D'}</span>`).join('')
                    : '<span class="text-slate-400 italic">Nenhum</span>';
                return `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3 text-sm font-mono text-slate-500">${op.sequence}</td>
                    <td class="px-4 py-3 text-sm text-slate-800 whitespace-nowrap">${op.description}</td>
                    <td class="px-4 py-3 text-sm font-bold font-mono text-center ${colorClass}">${value}</td>
                    <td class="px-4 py-3 text-sm font-mono text-center text-slate-600">${op.timeCentesimal}</td>
                    <td class="px-4 py-3 text-sm font-mono text-center text-slate-600">${op.operatorsReal}</td>
                    <td class="px-4 py-3 text-sm text-slate-600 whitespace-nowrap">${op.machine}</td>
                    <td class="px-4 py-3 text-sm text-slate-700">${operatorsHtml}</td>
                </tr>`;
            }).join('');

            const radius = 20;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (metrics.efficiencyValue / 100) * circumference;

            const progressRingHtml = `
                <svg class="w-12 h-12" viewBox="0 0 50 50">
                    <circle class="text-slate-200" stroke-width="5" stroke="currentColor" fill="transparent" r="${radius}" cx="25" cy="25"/>
                    <circle class="progress-ring__circle ${metrics.efficiencyColor}"
                        stroke-width="5"
                        stroke-dasharray="${circumference} ${circumference}"
                        style="stroke-dashoffset: ${offset}"
                        stroke="currentColor"
                        fill="transparent"
                        r="${radius}"
                        cx="25"
                        cy="25"
                    />
                </svg>
            `;

            publicContent.innerHTML = `
            <div class="p-4 sm:p-6 bg-white rounded-xl shadow-sm border">
                <div class="flex flex-col sm:flex-row flex-wrap justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">${modelName}</h2>
                        <p class="text-lg text-red-600 font-semibold">${firstOp.modelInfo.brand}</p>
                        <p class="text-md text-slate-600 mt-1">Célula: ${firstOp.modelInfo.celula || 'N/A'}</p>
                    </div>
                    <button id="back-to-public-main-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center gap-2 w-full sm:w-auto justify-center">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i> Voltar à Consulta
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-slate-50 p-4 rounded-lg border">
                        <dt class="text-sm font-medium text-slate-500">Tempo Total do Balanceamento</dt>
                        <dd class="mt-1 text-2xl font-bold font-mono text-slate-900">${metrics.totalTime} min</dd>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg border">
                        <dt class="text-sm font-medium text-slate-500">Pessoas Necessárias</dt>
                        <dd class="mt-1 text-2xl font-bold font-mono text-slate-900">${firstOp.modelInfo.totalPeople}</dd>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg border">
                        <dt class="text-sm font-medium text-slate-500">Meta de Produção</dt>
                        <dd class="mt-1 text-2xl font-bold font-mono text-slate-900">${firstOp.modelInfo.productionGoal}</dd>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg border flex items-center gap-4">
                        ${progressRingHtml}
                        <div>
                            <dt class="text-sm font-medium text-slate-500">Eficiência Geral</dt>
                            <dd class="mt-1 text-2xl font-bold font-mono ${metrics.efficiencyColor}">${metrics.efficiencyPercentage}</dd>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4 mt-4 py-4 border-t">
                    <button id="public-view-pdf-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 flex items-center gap-2 text-sm ${!firstOp.modelInfo.hasProcessPdf ? 'hidden' : ''}">
                        <i data-lucide="file-text" class="w-4 h-4"></i>Visualizar PDF do Balanceamento
                    </button>
                    <button id="public-view-layout-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 flex items-center gap-2 text-sm hidden">
                        <i data-lucide="layout-template" class="w-4 h-4"></i>Visualizar Layout da Célula
                    </button>
                </div>
                <div class="overflow-x-auto border rounded-lg mt-4">
                    <table class="min-w-full">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Seq.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Descrição da Operação</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Eficiência</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Tempo (Cent.)</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">OP.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Equipamento</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Operadores Vinculados</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200">${tableRows}</tbody>
                    </table>
                </div>
            </div>`;
            document.getElementById('back-to-public-main-btn').addEventListener('click', renderPublicContent);

            const sanitizedModelName = getSanitizedModelName(modelName);

            if (firstOp.modelInfo.hasProcessPdf) {
                document.getElementById('public-view-pdf-btn').addEventListener('click', () => {
                    const url = `processes/${sanitizedModelName}.pdf`;
                    window.open(url, '_blank');
                });
            }
            
            // CORRIGIDO: Verifica se o layout existe antes de mostrar o botão
            const layoutUrl = `layouts/${sanitizedModelName}.pdf`;
            fetch(layoutUrl, { method: 'HEAD' })
                .then(res => {
                    if (res.ok) {
                        const layoutBtn = document.getElementById('public-view-layout-btn');
                        if(layoutBtn) {
                           layoutBtn.classList.remove('hidden');
                           layoutBtn.addEventListener('click', () => {
                               openLayoutModalForPublic(modelName, operations);
                           });
                        }
                    }
                }).catch(err => console.warn(`Layout para ${modelName} não encontrado. Botão oculto.`));

            lucide.createIcons();
        };

        const renderPublicOperatorDetails = (operator, ops) => {
            const publicContent = ui.publicContent;
            if (!publicContent) return;
            let tableContent;
            if (ops.length === 0) {
                tableContent = `<div class="p-4 text-center text-slate-500 bg-slate-50 rounded-lg border">Este operador não está vinculado a nenhuma operação no momento.</div>`;
            } else {
                tableContent = `
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Balanceamento</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Célula</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID Op.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Descrição</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Ranking</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200">
                            ${ops.sort((a, b) => a.modelInfo.model.localeCompare(b.modelInfo.model) || a.sequence - b.sequence)
                                .map(op => {
                                    const operatorInOp = (op.assignedOperators || []).find(o => o.badgeId === operator.badgeId);
                                    const ranking = operatorInOp ? operatorInOp.ranking || 'N/D' : 'N/D';
                                    return `
                                    <tr class="hover:bg-slate-50 cursor-pointer public-op-row" data-model-name="${op.modelInfo.model}">
                                        <td class="px-4 py-3 text-sm font-semibold text-slate-800 whitespace-nowrap">${op.modelInfo.model}</td>
                                        <td class="px-4 py-3 text-sm text-slate-600">${op.modelInfo.celula || 'N/A'}</td>
                                        <td class="px-4 py-3 text-sm font-mono text-slate-500">${op.operationId.split('-').pop()}</td>
                                        <td class="px-4 py-3 text-sm text-slate-600 whitespace-nowrap">${op.description}</td>
                                        <td class="px-4 py-3 text-sm font-mono text-center text-red-600 font-bold">${ranking}</td>
                                    </tr>`;
                                }).join('')}
                        </tbody>
                    </table>
                </div>`;
            }
            publicContent.innerHTML = `
            <div class="p-4 sm:p-6 bg-white rounded-xl shadow-sm border">
                <div class="flex flex-col sm:flex-row flex-wrap justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl sm:text-3xl font-bold text-slate-800">Operações atribuídas a</h2>
                        <p class="text-lg text-red-600 font-semibold">${operator.name}</p>
                    </div>
                    <button id="back-to-public-main-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 flex items-center gap-2 w-full sm:w-auto justify-center">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i> Voltar à Consulta
                    </button>
                </div>
                ${tableContent}
            </div>`;
            document.getElementById('back-to-public-main-btn').addEventListener('click', renderPublicContent);

            document.querySelectorAll('.public-op-row').forEach(row => {
                row.addEventListener('click', async (e) => {
                    const modelName = e.currentTarget.dataset.modelName;
                    publicContent.innerHTML = `<div class="mx-auto loader mt-20"></div>`;
                    const response = await apiRequest(`${API_URL}?action=getOperations&modelName=${encodeURIComponent(modelName)}`);
                    if (response.status === 'success' && response.data.length > 0) {
                        renderPublicProcessDetails(modelName, response.data);
                    } else {
                        publicContent.innerHTML = `<p class="text-red-500 text-center">Balanceamento não encontrado.</p>`;
                    }
                });
            });

            lucide.createIcons();
        };

        const handlePublicOperatorBadgeSearch = async (event) => {
            const badgeId = event.target.value.trim();
            const statusContainer = document.getElementById('public-operator-status-container');
            if (!badgeId || !statusContainer) return;
            statusContainer.innerHTML = `<div class="mx-auto loader !w-6 !h-6 !border-2 mt-4"></div>`;

            const operatorResponse = await apiRequest(`${API_URL}?action=getOperators&badgeId=${badgeId}`);
            if (operatorResponse.status === 'success' && operatorResponse.data.length > 0) {
                const operatorData = operatorResponse.data[0];
                const opsResponse = await apiRequest(`${API_URL}?action=getOperations&badgeId=${badgeId}`);
                const assignedOps = opsResponse.status === 'success' ? opsResponse.data : [];
                renderPublicOperatorDetails(operatorData, assignedOps);
            } else {
                statusContainer.innerHTML = `<p class="text-red-500 font-semibold text-center mt-4">Crachá com código "${badgeId}" não está cadastrado.</p>`;
            }

            const input = document.getElementById('public-operator-badge-consult-input');
            if(input) input.value = '';
        };

        const renderPublicContent = async () => {
            const publicContent = ui.publicContent;
            if(!publicContent) return;
            publicContent.innerHTML = `
                <section class="space-y-4 p-4 sm:p-6 bg-white rounded-xl shadow-sm border mb-8">
                    <div class="flex items-center gap-3"><i data-lucide="search" class="text-red-500"></i><h2 class="text-xl font-semibold">Consultar Balanceamento Aprovado</h2></div>
                    <input type="text" id="public-search-input" placeholder="Digite o nome da célula ou do balanceamento..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500">
                </section>
                <section class="space-y-4 p-4 sm:p-6 bg-white rounded-xl shadow-sm border mb-8">
                    <div class="flex items-center gap-3"><i data-lucide="user-search" class="text-red-500"></i><h2 class="text-xl font-semibold">Consultar Operador por Crachá</h2></div>
                    <input type="text" id="public-operator-badge-consult-input" placeholder="Digite o código do crachá e pressione Enter" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500">
                    <div id="public-operator-status-container" class="min-h-[30px]"></div>
                </section>
                <div id="public-processes-loader" class="mx-auto loader mt-10"></div>
                <div id="public-processes-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                <div id="public-no-processes-message" class="hidden text-center text-slate-500 mt-10"><i data-lucide="folder-x" class="mx-auto h-16 w-16 mb-4 stroke-1"></i><h3 class="text-lg font-medium">Nenhum balanceamento aprovado encontrado.</h3></div>
            `;
            document.getElementById('public-operator-badge-consult-input').addEventListener('change', handlePublicOperatorBadgeSearch);

            const grid = document.getElementById('public-processes-grid');
            const loader = document.getElementById('public-processes-loader');
            const noResults = document.getElementById('public-no-processes-message');
            const searchInput = document.getElementById('public-search-input');

            const renderGrid = (opsMap) => {
                grid.innerHTML = '';
                if (opsMap.size === 0) {
                    noResults.style.display = 'block';
                    return;
                }
                noResults.style.display = 'none';
                opsMap.forEach((ops, modelName) => {
                    const op = ops[0];
                    const card = document.createElement('div');
                    card.className = `p-5 border rounded-xl bg-white shadow-sm hover:shadow-lg hover:border-red-500 transition cursor-pointer`;
                    card.innerHTML = `
                        <div class="font-bold text-red-600 text-sm">${op.modelInfo.brand || ''}</div>
                        <h4 class="font-bold text-lg text-slate-800 mt-1 truncate">${modelName}</h4>
                        <p class="text-sm text-slate-500 mt-2">Célula: ${op.modelInfo.celula || 'N/A'}</p>
                        <p class="text-sm text-slate-500 mt-1">${ops.length} operações</p>`;
                    card.addEventListener('click', () => renderPublicProcessDetails(modelName, ops));
                    grid.appendChild(card);
                });
            }

            loader.style.display = 'block';
            const response = await apiRequest(`${API_URL}?action=getOperations&status=aprovado`);
            loader.style.display = 'none';

            if (response.status === 'success') {
                let allOps = response.data;
                const groupOps = (ops) => {
                    const models = new Map();
                    ops.forEach(op => {
                        const modelName = op.modelInfo.model;
                        if (!models.has(modelName)) models.set(modelName, []);
                        models.get(modelName).push(op);
                    });
                    return models;
                }

                let allModels = groupOps(allOps);
                renderGrid(allModels);

                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    if (!searchTerm) {
                        renderGrid(allModels);
                        return;
                    }
                    const filteredOps = allOps.filter(op =>
                        op.modelInfo.model.toLowerCase().includes(searchTerm) ||
                        (op.modelInfo.celula && op.modelInfo.celula.toLowerCase().includes(searchTerm))
                    );
                    renderGrid(groupOps(filteredOps));
                });
            } else {
                grid.innerHTML = `<p class="text-red-500 col-span-full text-center">Não foi possível carregar os balanceamentos.</p>`;
            }
            lucide.createIcons();
        };

        // --- Funções de Renderização (App) ---
        const fetchAndRenderDashboard = async () => {};

        const renderProcessesPage = async () => {
            ui.processesGrid.innerHTML = '';
            ui.noProcessesMessage.style.display = 'none';
            ui.processesLoader.style.display = 'block';
            ui.processesSearchInput.value = '';

            const response = await apiRequest(`${API_URL}?action=getOperations&userRole=${currentUser.role}`);
            ui.processesLoader.style.display = 'none';

            if (response.status === 'success') {
                let allOps = response.data;

                if (currentUser?.role === 'analista') {
                    allOps = allOps.filter(op => op.modelInfo.ownerUid === currentUser.id);
                }

                if (allOps.length === 0) {
                    ui.noProcessesMessage.style.display = 'block';
                     if (currentUser.role === 'analista') {
                        ui.noProcessesMessage.innerHTML = '<i data-lucide="folder-x" class="mx-auto h-16 w-16 mb-4 stroke-1"></i><h3 class="text-lg font-medium">Você ainda não carregou nenhum balanceamento.</h3><p>Vá para o painel para começar.</p>';
                    } else if (currentUser.role === 'lideranca') {
                         ui.noProcessesMessage.innerHTML = '<i data-lucide="folder-x" class="mx-auto h-16 w-16 mb-4 stroke-1"></i><h3 class="text-lg font-medium">Nenhum balanceamento aprovado para gestão.</h3><p>Aguarde a aprovação do gerente.</p>';
                    }
                    lucide.createIcons();
                    return;
                }

                allProcessesMap.clear();
                allOps.forEach(op => {
                    if (op.modelInfo && op.modelInfo.model) {
                        const modelName = op.modelInfo.model;
                        if (!allProcessesMap.has(modelName)) allProcessesMap.set(modelName, []);
                        allProcessesMap.get(modelName).push(op);
                    }
                });

                renderProcessCards(allProcessesMap);

            } else {
                ui.processesGrid.innerHTML = `<p class="text-red-500">Não foi possível carregar os balanceamentos.</p>`;
            }
        };

        const renderProcessCards = (processesMap) => {
            ui.processesGrid.innerHTML = '';

            if (processesMap.size === 0) {
                 ui.processesGrid.innerHTML = `<p class="text-slate-500 col-span-full text-center">Nenhum balanceamento encontrado para o seu filtro.</p>`;
                 return;
            }

            processesMap.forEach((ops, modelName) => {
                const op = ops[0];
                const card = document.createElement('div');
                card.className = `process-card p-5 border rounded-xl bg-white shadow-sm hover:shadow-md hover:border-red-500 transition cursor-pointer relative`;
                card.dataset.modelName = modelName;
                card.dataset.celula = op.modelInfo.celula || '';

                let statusBadge = '';
                if (op.status === 'aprovado') {
                    statusBadge = '<div class="absolute top-3 right-3 text-xs bg-green-100 text-green-800 font-bold px-2 py-1 rounded-full flex items-center gap-1"><i data-lucide="check-circle-2" class="w-4 h-4"></i>Aprovado</div>';
                } else if (op.status === 'reprovado') {
                    statusBadge = '<div class="absolute top-3 right-3 text-xs bg-red-100 text-red-800 font-bold px-2 py-1 rounded-full flex items-center gap-1"><i data-lucide="x-circle" class="w-4 h-4"></i>Reprovado</div>';
                } else {
                    statusBadge = '<div class="absolute top-3 right-3 text-xs bg-amber-100 text-amber-800 font-bold px-2 py-1 rounded-full flex items-center gap-1"><i data-lucide="timer" class="w-4 h-4"></i>Pendente</div>';
                }

                card.innerHTML = `
                    <div class="font-bold text-red-600 text-sm">${op.modelInfo.brand || ''}</div>
                    <h4 class="font-bold text-lg text-slate-800 mt-1 truncate pr-20">${modelName}</h4>
                    <p class="text-sm text-slate-500 mt-2">Célula: ${op.modelInfo.celula || 'N/A'}</p>
                    <p class="text-sm text-slate-500 mt-1">${ops.length} operações</p>
                    ${statusBadge}`;

                card.addEventListener('click', () => {
                    lastProcessedOperations = ops;
                    renderOperationsList(ops);
                    showPage('pageHome');
                });
                ui.processesGrid.appendChild(card);
            });
            lucide.createIcons();
        }

        const renderOperationsList = (ops) => {
            ui.operationsTableBody.innerHTML = '';
            if (!ops || ops.length === 0) {
                showHomeState('welcome');
                return;
            }

            const metrics = calculateOverallProcessMetrics(ops);
            renderProcessHeader(ops[0].modelInfo, metrics, ops);

            currentProcessModelName = ops[0].modelInfo.model;
            ui.operationsListActions.style.display = 'flex';

            const isApproved = ops[0].status === 'aprovado';
            const isRejected = ops[0].status === 'reprovado';

            ui.approveProcessBtn.disabled = isApproved;
            ui.approveProcessBtn.classList.toggle('bg-gray-400', isApproved);
            ui.approveProcessBtn.classList.toggle('hover:bg-gray-400', isApproved);
            ui.approveProcessBtn.classList.toggle('cursor-not-allowed', isApproved);
            ui.approveProcessBtn.classList.toggle('bg-teal-500', !isApproved);

            ui.rejectProcessBtn.disabled = isRejected;
            ui.rejectProcessBtn.classList.toggle('bg-gray-400', isRejected);
            ui.rejectProcessBtn.classList.toggle('hover:bg-gray-400', isRejected);
            ui.rejectProcessBtn.classList.toggle('cursor-not-allowed', isRejected);
            ui.rejectProcessBtn.classList.toggle('bg-amber-500', !isRejected);

            ops.sort((a, b) => parseInt(a.sequence) - parseInt(b.sequence));
            ops.forEach(op => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50';
                row.dataset.opId = op.operationId;

                const { value, colorClass } = calculateEfficiency(op);

                let opTags = '';
                if (op.isGrouped) {
                    opTags += `<span title="Operação Agrupada" class="p-1 text-blue-500"><i data-lucide="group" class="w-4 h-4"></i></span>`;
                }
                if ((op.assignedOperators?.length || 0) > parseInt(op.operatorsReal)) {
                    opTags += `<span title="Mais operadores que o necessário" class="p-1 text-red-500"><i data-lucide="alert-triangle" class="w-4 h-4"></i></span>`;
                }

                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-slate-500">${op.operationId.split('-').pop()}</td>
                    <td class="px-4 py-3 text-sm text-slate-800 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                           <span class="cursor-pointer view-op-details">${op.description}</span>
                           <div class="flex items-center gap-1">${opTags}</div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm font-mono text-center font-bold ${colorClass}">${value}</td>
                    <td class="px-4 py-3 text-sm font-mono text-center text-slate-600">${op.timeCentesimal}</td>
                    <td class="px-4 py-3 text-sm font-mono text-center text-slate-600">${op.operatorsReal}</td>
                    <td class="px-4 py-3 text-sm text-slate-600 whitespace-nowrap">${op.machine || 'N/A'}</td>
                    <td class="px-4 py-3 text-center">
                        <button class="manage-team-btn bg-slate-100 text-slate-700 text-xs font-semibold px-3 py-1.5 rounded-md hover:bg-slate-200 flex items-center gap-1.5">
                            <i data-lucide="users" class="w-4 h-4"></i> Gerir
                        </button>
                    </td>`;
                ui.operationsTableBody.appendChild(row);
            });

            ui.operationsTableBody.addEventListener('click', (e) => {
                const target = e.target;
                const row = target.closest('tr');
                if (!row) return;

                const opId = row.dataset.opId;
                const operation = lastProcessedOperations.find(op => op.operationId === opId);
                if (!operation) return;

                if (target.closest('.manage-team-btn')) {
                    openManageTeamModal(operation);
                } else if (target.closest('.view-op-details')) {
                    showSingleOperationView(opId);
                }
            });

            ui.operationsListContainer.style.display = 'block';
            ui.resultContent.style.display = 'none';
            ui.operatorConsultResultsContainer.style.display = 'none';
            showHomeState('process');
            updateUIForPermissions();
            lucide.createIcons();
        };

        const renderProcessHeader = (modelInfo, metrics, ops) => {
            const canEdit = currentUser && ['admin', 'gerente', 'analista'].includes(currentUser.role);
            const unmanagedOpsCount = ops.filter(op => !op.assignedOperators || op.assignedOperators.length === 0).length;
            const brandOptions = ['Nike', 'Fila', 'Osklen', 'Outra'].map(brand =>
                `<option value="${brand}" ${modelInfo.brand === brand ? 'selected' : ''}>${brand}</option>`
            ).join('');

            const brandHtml = `
                <div id="brand-display" class="flex items-center gap-2">
                    <span id="brand-display-text" class="font-semibold text-red-600">${modelInfo.brand}</span>
                    ${canEdit ? `<button id="edit-brand-btn" class="text-slate-500 hover:text-slate-800 p-1 rounded-full" title="Editar Marca"><i data-lucide="edit-3" class="w-4 h-4"></i></button>` : ''}
                </div>
                <div id="brand-edit-container" class="hidden items-center gap-2">
                     <select id="brand-edit-select" class="w-32 p-1 border bg-white border-slate-300 rounded-md text-sm">${brandOptions}</select>
                     <button id="save-brand-btn" class="p-1 text-green-600 hover:bg-green-100 rounded-full" title="Salvar Marca"><i data-lucide="check" class="w-5 h-5"></i></button>
                     <button id="cancel-brand-btn" class="p-1 text-red-600 hover:bg-red-100 rounded-full" title="Cancelar"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            `;

            const radius = 20;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (metrics.efficiencyValue / 100) * circumference;

            const progressRingHtml = `
                <svg class="w-12 h-12" viewBox="0 0 50 50">
                    <circle class="text-slate-200" stroke-width="5" stroke="currentColor" fill="transparent" r="${radius}" cx="25" cy="25"/>
                    <circle class="progress-ring__circle ${metrics.efficiencyColor}"
                        stroke-width="5"
                        stroke-dasharray="${circumference} ${circumference}"
                        style="stroke-dashoffset: ${offset}"
                        stroke="currentColor" fill="transparent" r="${radius}" cx="25" cy="25"/>
                </svg>`;

            const date = modelInfo.creationDate ? new Date(modelInfo.creationDate) : null;
            const formattedDate = date ? date.toLocaleDateString('pt-BR') : 'N/D';
            const formattedTime = date ? date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 'N/D';

            // CORRIGIDO: Lê o status do checklist a partir do modelInfo
            const hasLayout = modelInfo.hasLayoutPdf;
            const hasProcess = modelInfo.hasProcessPdf;
            const checklistHtml = `
                <div class="mt-3 p-3 bg-white border rounded-lg space-y-2">
                    <h5 class="text-sm font-bold text-slate-700">Checklist do Balanceamento</h5>
                    <div class="flex items-center gap-2 text-sm ${hasProcess ? 'text-green-600 font-medium' : 'text-slate-500'}">
                        ${hasProcess ? '<i data-lucide="check-square" class="w-4 h-4"></i>' : '<i data-lucide="square" class="w-4 h-4"></i>'}
                        <span>PDF do Balanceamento Carregado</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm ${hasLayout ? 'text-green-600 font-medium' : 'text-slate-500'}">
                        ${hasLayout ? '<i data-lucide="check-square" class="w-4 h-4"></i>' : '<i data-lucide="square" class="w-4 h-4"></i>'}
                        <span>PDF do Layout Carregado</span>
                    </div>
                </div>
            `;

            ui.processHeaderBlock.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                    <div>
                        <h3 class="text-xl font-bold text-slate-800">${modelInfo.model}</h3>
                        <div class="mt-1">${brandHtml}</div>
                        <dl class="mt-2 grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-x-6 gap-y-2 text-sm">
                            <div><dt class="font-semibold text-slate-600">Célula:</dt><dd>${modelInfo.celula || 'N/A'}</dd></div>
                            <div><dt class="font-semibold text-slate-600">Nº Pessoas:</dt><dd class="font-mono">${modelInfo.totalPeople}</dd></div>
                            <div><dt class="font-semibold text-slate-600">Meta Produção:</dt><dd class="font-mono">${modelInfo.productionGoal}</dd></div>
                            <div><dt class="font-semibold text-slate-600">Turno:</dt><dd class="font-mono">${getWorkShiftName(modelInfo.workdayMinutes)}</dd></div>
                            <div><dt class="font-semibold text-slate-600">Op. a Gerir:</dt><dd class="font-mono font-bold ${unmanagedOpsCount > 0 ? 'text-amber-600' : 'text-green-600'}">${unmanagedOpsCount}</dd></div>
                        </dl>
                        <div class="mt-2 text-xs text-slate-500">
                            Carregado por: <span class="font-medium text-slate-700">${modelInfo.ownerEmail}</span> em <span class="font-medium text-slate-700">${formattedDate}</span> às <span class="font-medium text-slate-700">${formattedTime}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 ml-auto">
                         <button id="manage-layout-btn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 flex items-center gap-2 text-sm">
                            <i data-lucide="layout-template" class="w-4 h-4"></i>Gerir Layout e PDF
                         </button>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-lg border">
                        <dt class="text-sm font-medium text-slate-500">Tempo Total do Balanceamento</dt>
                        <dd class="mt-1 text-2xl font-bold font-mono text-slate-900">${metrics.totalTime} min</dd>
                    </div>
                    <div class="bg-white p-4 rounded-lg border flex items-center gap-4">
                        ${progressRingHtml}
                        <div>
                            <dt class="text-sm font-medium text-slate-500">Eficiência Geral</dt>
                            <dd class="mt-1 text-2xl font-bold font-mono ${metrics.efficiencyColor}">${metrics.efficiencyPercentage}</dd>
                        </div>
                    </div>
                    <div class="md:col-span-1">
                        ${checklistHtml}
                    </div>
                </div>`;

            const manageLayoutBtn = document.getElementById('manage-layout-btn');
            if (manageLayoutBtn) {
                manageLayoutBtn.addEventListener('click', openLayoutModal);
            }

            if (canEdit) {
                document.getElementById('edit-brand-btn').addEventListener('click', () => toggleBrandEdit(true));
                document.getElementById('cancel-brand-btn').addEventListener('click', () => toggleBrandEdit(false));
                document.getElementById('save-brand-btn').addEventListener('click', handleSaveBrand);
            }
            lucide.createIcons();
            ui.processHeaderBlock.style.display = 'block';
        };

        const showSingleOperationView = (opId) => {
            const op = lastProcessedOperations.find(o => o.operationId === opId);
            if (!op) return;

            currentOperation = op;

            const metrics = calculateOverallProcessMetrics(lastProcessedOperations);
            renderProcessHeader(op.modelInfo, metrics, lastProcessedOperations);

            ui.resultId.textContent = `Operação: ${op.operationId.split('-').pop()}`;
            ui.resultDescription.textContent = op.description;
            ui.resultMachine.textContent = op.machine;
            ui.resultSequence.textContent = op.sequence;
            ui.resultTimeCentesimal.textContent = `${op.timeCentesimal} min`;
            ui.resultTimeSeconds.textContent = `${op.timeSeconds} seg`;
            ui.resultOperatorsReal.textContent = op.operatorsReal;
            ui.observationText.value = op.observation || '';
            ui.resultOwnerEmail.textContent = op.modelInfo.ownerEmail;
            ui.resultCreationDate.textContent = new Date(op.modelInfo.creationDate).toLocaleString('pt-BR');

            const { value, colorClass } = calculateEfficiency(op);
            ui.resultEfficiency.textContent = value;
            ui.resultEfficiency.className = `mt-1 text-4xl font-bold font-mono ${colorClass}`;

            renderAssignedOperatorsForDetailView();

            ui.operationsListActions.style.display = 'none';
            ui.operationsListContainer.style.display = 'none';
            ui.resultContent.style.display = 'block';
            showHomeState('process');
            updateUIForPermissions();
        };

        const renderAssignedOperatorsForDetailView = () => {
            const listContainer = ui.assignedOperatorsListDetail;
            const countStatus = ui.operatorCountStatusDetail;
            const assigned = currentOperation.assignedOperators || [];
            const required = parseInt(currentOperation.operatorsReal) || 0;

            countStatus.textContent = `Operadores Vinculados: ${assigned.length} de ${required}`;

            if (assigned.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-slate-500 italic">Nenhum operador vinculado.</p>';
            } else {
                listContainer.innerHTML = '';
                assigned.forEach(op => {
                    const opEl = document.createElement('div');
                    opEl.className = 'bg-slate-100 p-2 rounded-md text-sm font-medium text-slate-800';
                    opEl.textContent = `${op.name} (Ranking: ${op.ranking || 'N/D'})`;
                    listContainer.appendChild(opEl);
                });
            }
        };

        const handleOperatorBadgeSearch = async (event) => {
            const badgeId = event.target.value.trim();
            if (badgeId === '') {
                showHomeState('welcome');
                return;
            };
            showHomeState('loading');

            const operatorResponse = await apiRequest(`${API_URL}?action=getOperators&badgeId=${badgeId}`);
            if (operatorResponse.status === 'success' && operatorResponse.data.length > 0) {
                 const operatorData = operatorResponse.data[0];
                 const opsResponse = await apiRequest(`${API_URL}?action=getOperations&badgeId=${badgeId}`);
                 const assignedOps = opsResponse.status === 'success' ? opsResponse.data : [];
                 renderOperatorAssignmentList(assignedOps, operatorData.name);
            } else {
                 showHomeState('error', `Crachá com código "${badgeId}" não está cadastrado.`);
            }

            event.target.value = '';
            event.target.focus();
        };

        const renderOperatorAssignmentList = (ops, operatorName) => {
            let tableContent;
            if (ops.length === 0) {
                tableContent = `<div class="p-4 text-center text-slate-500 bg-slate-50 rounded-lg border">Este operador não está vinculado a nenhuma operação no momento.</div>`;
            } else {
                tableContent = `
                <div class="overflow-x-auto max-h-[500px] border rounded-lg">
                    <table class="min-w-full">
                        <thead class="bg-slate-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Balanceamento</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Célula</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID Op.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Descrição</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200">
                            ${ops.map(op => `
                            <tr class="hover:bg-slate-50 cursor-pointer" data-model-name="${op.modelInfo.model}">
                                <td class="px-4 py-3 text-sm font-semibold text-slate-800 whitespace-nowrap">${op.modelInfo.model}</td>
                                <td class="px-4 py-3 text-sm text-slate-600">${op.modelInfo.celula || 'N/A'}</td>
                                <td class="px-4 py-3 text-sm font-mono text-slate-500">${op.operationId.split('-').pop()}</td>
                                <td class="px-4 py-3 text-sm text-slate-600 whitespace-nowrap">${op.description}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>`;
            }
            ui.processViewContainer.style.display = 'flex';
            ui.processHeaderBlock.style.display = 'none';
            ui.operationsListActions.style.display = 'none';
            ui.operationsListContainer.style.display = 'none';
            ui.resultContent.style.display = 'none';
            ui.operatorConsultResultsContainer.innerHTML = `
                <div class="mb-4">
                    <h3 class="text-2xl font-bold text-slate-800">Operações atribuídas a</h3>
                    <p class="text-xl font-semibold text-red-600">${operatorName}</p>
                </div>
                ${tableContent}`;
            ui.operatorConsultResultsContainer.style.display = 'block';

            document.querySelectorAll('#operator-consult-results-container tr[data-model-name]').forEach(row => {
                row.addEventListener('click', async (e) => {
                    const modelName = e.currentTarget.dataset.modelName;
                    showHomeState('loading');
                    const response = await apiRequest(`${API_URL}?action=getOperations&modelName=${encodeURIComponent(modelName)}`);
                    if (response.status === 'success' && response.data.length > 0) {
                        lastProcessedOperations = response.data;
                        renderOperationsList(lastProcessedOperations);
                    }
                });
            });
        };

        const renderAnalyticsPage = async () => {
            Object.values(chartInstances).forEach(chart => chart.destroy());
            const pageContainer = document.getElementById('page-analytics');
            pageContainer.innerHTML = `<div class="mx-auto loader mt-20"></div>`;

            const opsResponse = await apiRequest(`${API_URL}?action=getOperations`);
            const operatorsResponse = await apiRequest(`${API_URL}?action=getOperators`);

            if (opsResponse.status !== 'success' || operatorsResponse.status !== 'success') {
                pageContainer.innerHTML = `<p class="text-red-500 text-center">Falha ao carregar dados para análise.</p>`;
                return;
            }

            const allOps = opsResponse.data;
            const totalOperators = operatorsResponse.data.length;

            const processes = new Map();
            allOps.forEach(op => {
                if (op.modelInfo && op.modelInfo.model) {
                    const modelName = op.modelInfo.model;
                    if (!processes.has(modelName)) {
                        processes.set(modelName, {
                            ops: [],
                            ownerEmail: op.modelInfo.ownerEmail,
                            celula: op.modelInfo.celula,
                            status: op.status
                        });
                    }
                    processes.get(modelName).ops.push(op);
                } else {
                    console.warn("Operação ignorada na análise por dados incompletos:", op);
                }
            });

            let approvedCount = 0, rejectedCount = 0, pendingCount = 0;
            let unmanagedProcesses = [];
            let overstaffedOps = [];
            let opsToManageCount = 0;
            let totalEfficiency = 0;
            let managedProcessesCount = 0;
            let totalManagedEfficiency = 0;

            processes.forEach((processData, modelName) => {
                if (processData.status === 'aprovado') approvedCount++;
                else if (processData.status === 'reprovado') rejectedCount++;
                else pendingCount++;

                let isProcessUnmanaged = false;
                processData.ops.forEach(op => {
                    const assignedCount = op.assignedOperators?.length || 0;
                    if (assignedCount === 0) {
                        isProcessUnmanaged = true;
                        opsToManageCount++;
                    }
                    if (assignedCount > parseInt(op.operatorsReal, 10)) {
                        overstaffedOps.push(op);
                    }
                });

                if (isProcessUnmanaged) {
                    unmanagedProcesses.push({ modelName, celula: processData.celula });
                }

                const metrics = calculateOverallProcessMetrics(processData.ops);
                if (!isNaN(metrics.efficiencyValue)) {
                    totalEfficiency += metrics.efficiencyValue;
                    const isManaged = processData.ops.some(op => op.assignedOperators && op.assignedOperators.length > 0);
                    if (isManaged) {
                        managedProcessesCount++;
                        totalManagedEfficiency += metrics.efficiencyValue;
                    }
                }
            });

            const avgEfficiencyAll = processes.size > 0 ? (totalEfficiency / processes.size) : 0;
            const avgEfficiencyManaged = managedProcessesCount > 0 ? (totalManagedEfficiency / managedProcessesCount) : 0;

            const sectorOverstaffCount = {};
            overstaffedOps.forEach(op => {
                const celula = op.modelInfo.celula || 'Não especificado';
                const excess = (op.assignedOperators.length || 0) - parseInt(op.operatorsReal, 10);
                sectorOverstaffCount[celula] = (sectorOverstaffCount[celula] || 0) + excess;
            });
            const sectorData = Object.entries(sectorOverstaffCount).sort(([, a], [, b]) => b - a).slice(0, 7);

            const analystProcessCount = {};
            processes.forEach(process => {
                const email = process.ownerEmail || 'Desconhecido';
                analystProcessCount[email] = (analystProcessCount[email] || 0) + 1;
            });
            const analystData = Object.entries(analystProcessCount).sort(([, a], [, b]) => b - a).slice(0, 7);

            pageContainer.innerHTML = `
                <h2 class="text-2xl sm:text-3xl font-bold mb-6">Painel Analítico</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border flex items-center gap-4"><i data-lucide="archive" class="w-8 h-8 text-slate-500"></i><div><p class="text-slate-500 text-sm font-medium">Total de Balanceamentos</p><p class="text-3xl font-bold">${processes.size}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border flex items-center gap-4"><i data-lucide="check-circle-2" class="w-8 h-8 text-green-500"></i><div><p class="text-slate-500 text-sm font-medium">Aprovados</p><p class="text-3xl font-bold">${approvedCount}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border flex items-center gap-4"><i data-lucide="timer" class="w-8 h-8 text-amber-500"></i><div><p class="text-slate-500 text-sm font-medium">Pendentes</p><p class="text-3xl font-bold">${pendingCount}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border flex items-center gap-4"><i data-lucide="users" class="w-8 h-8 text-blue-500"></i><div><p class="text-slate-500 text-sm font-medium">Operadores Cadastrados</p><p class="text-3xl font-bold">${totalOperators}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border flex items-center gap-4"><i data-lucide="percent" class="w-8 h-8 text-indigo-500"></i><div><p class="text-slate-500 text-sm font-medium">Eficiência Média (Geral)</p><p class="text-3xl font-bold">${avgEfficiencyAll.toFixed(2)}%</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border flex items-center gap-4"><i data-lucide="user-check" class="w-8 h-8 text-teal-500"></i><div><p class="text-slate-500 text-sm font-medium">Eficiência Média (Geridos)</p><p class="text-3xl font-bold">${avgEfficiencyManaged.toFixed(2)}%</p></div></div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border flex items-center gap-4"><i data-lucide="user-x" class="w-8 h-8 text-orange-500"></i><div><p class="text-slate-500 text-sm font-medium">Balanceamentos Não Geridos</p><p class="text-3xl font-bold">${unmanagedProcesses.length}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border flex items-center gap-4"><i data-lucide="user-plus" class="w-8 h-8 text-red-500"></i><div><p class="text-slate-500 text-sm font-medium">Op. com Excesso Pessoal</p><p class="text-3xl font-bold">${overstaffedOps.length}</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border flex items-center gap-4"><i data-lucide="user-cog" class="w-8 h-8 text-indigo-500"></i><div><p class="text-slate-500 text-sm font-medium">Operações a Gerir</p><p class="text-3xl font-bold">${opsToManageCount}</p></div></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                    <div id="container-unmanaged-processes" class="bg-white p-6 rounded-xl shadow-sm border">
                        <h3 class="text-xl font-semibold mb-4">Balanceamentos que Requerem Gestão</h3>
                        <div class="max-h-80 overflow-y-auto space-y-2">
                            ${unmanagedProcesses.length > 0 ? unmanagedProcesses.map(p => `
                                <div class="analytic-item p-3 border rounded-lg hover:bg-red-50 hover:border-red-400 cursor-pointer transition-colors" data-model-name="${p.modelName}">
                                    <p class="font-semibold text-slate-800">${p.modelName}</p>
                                    <p class="text-sm text-slate-500">Setor: ${p.celula || 'N/A'}</p>
                                </div>
                            `).join('') : `<p class="text-slate-500 italic text-center p-4">Nenhum balanceamento a gerir. Bom trabalho!</p>`}
                        </div>
                    </div>

                    <div id="container-overstaffed-ops" class="bg-white p-6 rounded-xl shadow-sm border">
                        <h3 class="text-xl font-semibold mb-4">Operações com Excesso de Pessoal</h3>
                        <div class="max-h-80 overflow-y-auto space-y-2">
                            ${overstaffedOps.length > 0 ? overstaffedOps.map(op => `
                                <div class="analytic-item p-3 border rounded-lg hover:bg-red-50 hover:border-red-400 cursor-pointer transition-colors" data-model-name="${op.modelInfo.model}">
                                    <p class="font-semibold text-slate-800">${op.modelInfo.model} <span class="font-normal text-slate-500">(Seq: ${op.sequence})</span></p>
                                    <p class="text-sm text-slate-600 truncate">${op.description}</p>
                                    <p class="text-sm text-red-600 font-bold mt-1">Vinculados: ${op.assignedOperators.length} / Necessário: ${op.operatorsReal}</p>
                                </div>
                            `).join('') : `<p class="text-slate-500 italic text-center p-4">Nenhuma operação com excesso de pessoal.</p>`}
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-sm border h-[400px]">
                        <h3 class="text-xl font-semibold mb-4">Média de Eficiência dos Balanceamentos</h3>
                        <canvas id="efficiency-averages-chart"></canvas>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-sm border h-[400px]">
                        <h3 class="text-xl font-semibold mb-4">Top Setores com Excesso de Pessoal</h3>
                        <canvas id="overstaffed-by-sector-chart"></canvas>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border h-[400px] lg:col-span-2">
                        <h3 class="text-xl font-semibold mb-4">Analistas Mais Ativos (Balanceamentos Gerados)</h3>
                        <canvas id="top-analysts-chart"></canvas>
                    </div>
                </div>
            `;

            const navigateToProcess = (modelName) => {
                const processOps = allOps.filter(op => op.modelInfo && op.modelInfo.model === modelName);
                if (processOps.length > 0) {
                    lastProcessedOperations = processOps;
                    renderOperationsList(processOps);
                    showPage('pageHome');
                }
            };

            pageContainer.querySelectorAll('.analytic-item').forEach(item => {
                item.addEventListener('click', (e) => navigateToProcess(e.currentTarget.dataset.modelName));
            });

            chartInstances.efficiencyAverages = new Chart(document.getElementById('efficiency-averages-chart'), {
                type: 'bar',
                data: {
                    labels: ['Média Geral', 'Média Balanceamentos Geridos'],
                    datasets: [{
                        label: 'Eficiência Média (%)',
                        data: [avgEfficiencyAll.toFixed(2), avgEfficiencyManaged.toFixed(2)],
                        backgroundColor: ['#6366f1', '#14b8a6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 120 } } }
            });

            if (sectorData.length > 0) {
                chartInstances.sectorOverstaffing = new Chart(document.getElementById('overstaffed-by-sector-chart'), {
                    type: 'bar', data: { labels: sectorData.map(d => d[0]), datasets: [{ label: 'Operadores em Excesso', data: sectorData.map(d => d[1]), backgroundColor: '#ef4444' }] },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
                });
            }

            if (analystData.length > 0) {
                chartInstances.topAnalysts = new Chart(document.getElementById('top-analysts-chart'), {
                    type: 'bar', data: { labels: analystData.map(d => d[0]), datasets: [{ label: 'Nº de Balanceamentos', data: analystData.map(d => d[1]), backgroundColor: '#4f46e5' }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            lucide.createIcons();
        };

        // --- Funções de Processamento de Arquivos e Dados ---
        // CORRIGIDO: Adicionado pre-load dos balanceamentos para checar duplicados
        const handleProcessFiles = async () => {
            const fileStatusEl = ui.fileStatus;
            const celula = ui.celulaInput.value.trim();
            const brand = ui.brandInput.value;
            const csvFile = ui.csvUpload.files[0];

            if (!celula || !brand || !csvFile) {
                fileStatusEl.innerHTML = `<span class="text-red-500 font-semibold">Por favor, preencha todos os campos.</span>`;
                return;
            }

            ui.processFileBtn.disabled = true;
            fileStatusEl.innerHTML = `<div class="flex items-center justify-center gap-2 text-blue-600"><div class="loader !w-5 !h-5 !border-2"></div>Carregando dados existentes...</div>`;

            // Garante que o mapa de processos está atualizado antes de verificar nomes
            await ensureProcessesLoaded();

            fileStatusEl.innerHTML = `<div class="flex items-center justify-center gap-2 text-blue-600"><div class="loader !w-5 !h-5 !border-2"></div>Lendo arquivo CSV...</div>`;

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csvText = event.target.result;
                    if (!csvText || csvText.trim() === '') {
                       throw new Error("O arquivo CSV está vazio ou é inválido.");
                    }
                    const parsedData = parseCrystalReportCSV(csvText, celula, brand);
                    const groupedData = processAndGroupOperations(parsedData);
                    await saveExtractedData(groupedData);
                } catch (error) {
                    console.error("Erro detalhado ao processar CSV:", error);
                    fileStatusEl.innerHTML = `<span class="text-red-500 font-semibold" title="${error.stack || ''}">Erro: ${error.message || 'Falha ao ler o CSV.'}</span>`;
                    ui.processFileBtn.disabled = false;
                }
            };
            reader.onerror = () => {
                fileStatusEl.innerHTML = `<span class="text-red-500 font-semibold">Não foi possível ler o arquivo.</span>`;
                ui.processFileBtn.disabled = false;
            };
            reader.readAsText(csvFile, 'ISO-8859-1');
        };
        
        // CORRIGIDO: Nova função para carregar processos em cache
        async function ensureProcessesLoaded() {
            const response = await apiRequest(`${API_URL}?action=getOperations`);
            if (response.status === 'success' && response.data) {
                allProcessesMap.clear();
                response.data.forEach(op => {
                    if (op.modelInfo && op.modelInfo.model) {
                        const modelName = op.modelInfo.model;
                        if (!allProcessesMap.has(modelName)) allProcessesMap.set(modelName, []);
                        allProcessesMap.get(modelName).push(op);
                    }
                });
            }
        }

        const parseCrystalReportCSV = (csvText, celula, brand) => {
            const lines = csvText.trim().split('\n');
            const modelInfo = {
                celula: celula,
                brand: brand,
                model: 'N/D',
                productionGoal: 0,
                workdayMinutes: 0,
                totalPeople: 0
            };
            const operations = [];

            const findValue = (key, text) => {
                const regex = new RegExp(`"${key}",\\s*"([^"]+)"`);
                const match = text.match(regex);
                return match ? match[1].trim() : null;
            };

            const parseCsvRow = (rowString) => {
                const result = [];
                let currentField = '';
                let inQuotes = false;
                for (let i = 0; i < rowString.length; i++) {
                    const char = rowString[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(currentField);
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                result.push(currentField);
                return result.map(field => field.replace(/^"|"$/g, '').trim());
            };

            const firstLine = lines[0] || '';
            modelInfo.model = findValue("Ref./Produto:", firstLine)?.split('/')[1]?.trim() || findValue("Nome Balanc.:", firstLine) || 'Modelo Não Encontrado';
            modelInfo.productionGoal = parseInt(findValue("Meta Prod.:", firstLine) || '0', 10);
            modelInfo.workdayMinutes = parseInt(findValue("Turno:", firstLine) || '0', 10);

            const totalLine = lines.find(line => line.includes(',"TOTAL",'));
            if (totalLine) {
                const totalParts = parseCsvRow(totalLine);
                const totalIndex = totalParts.indexOf('TOTAL');
                if (totalIndex > -1 && totalParts.length > totalIndex + 3) {
                    modelInfo.totalPeople = parseInt(totalParts[totalIndex + 3] || '0', 10);
                }
            }

            for (const line of lines) {
                const allFields = parseCsvRow(line);
                let seqIndex = -1;
                for (let i = 0; i < allFields.length; i++) {
                    const field = allFields[i];
                    if (field && /^\d+$/.test(field) && allFields[i + 1] && /^\d+$/.test(allFields[i + 1])) {
                        seqIndex = i;
                        break;
                    }
                }

                if (seqIndex !== -1) {
                    const opValues = allFields.slice(seqIndex);
                    if (opValues.length >= 9) {
                         const timeCentesimal = parseFloat(opValues[5]?.replace(',', '.') || 0);
                         const timeSeconds = timeCentesimal * 60;
                         operations.push({
                             sequence: opValues[0] || '',
                             operationId: opValues[1] || '',
                             description: opValues[2] || '',
                             machine: opValues[4] || '',
                             timeCentesimal: timeCentesimal.toFixed(3),
                             timeSeconds: timeSeconds.toFixed(3),
                             operatorsCalc: opValues[7]?.replace(',', '.') || '0',
                             operatorsReal: opValues[8] || '0',
                             agrup: opValues[6] || '',
                         });
                    }
                }
            }

            if (operations.length === 0) {
                throw new Error("Nenhuma operação válida foi encontrada. Verifique o formato do arquivo CSV.");
            }

            if (!modelInfo.totalPeople || modelInfo.totalPeople === 0) {
                modelInfo.totalPeople = operations.reduce((sum, op) => sum + (parseInt(op.operatorsReal, 10) || 0), 0);
            }
            
            const uniqueOperations = Array.from(new Map(operations.map(op => [op.sequence, op])).values());
            return { modelInfo, operations: uniqueOperations };
        };

        const processAndSaveData = (data) => {
            ui.fileStatus.innerHTML = `<div class="flex items-center justify-center gap-2 text-blue-600"><div class="loader !w-5 !h-5 !border-2"></div>Processando operações...</div>`;
            const processedData = processAndGroupOperations(data);
            saveExtractedData(processedData);
        };

        const processAndGroupOperations = (data) => {
            if (!data.operations || data.operations.length === 0) return data;

            const processedOps = [];
            let accumulatedTime = 0;
            let accumulatedDescriptions = [];
            let accumulatedOps = [];

            for (let i = 0; i < data.operations.length; i++) {
                let currentOp = data.operations[i];
                const agrupValue = (currentOp.agrup || "").trim().toUpperCase();

                if (agrupValue === "A") {
                    // É uma sub-operação, acumula
                    accumulatedTime += parseFloat(currentOp.timeCentesimal) || 0;
                    accumulatedDescriptions.push(currentOp.description);
                    accumulatedOps.push(currentOp);
                } else {
                    // É uma operação principal (ou independente)
                    if (accumulatedOps.length > 0) {
                        // Se tem acumulado, soma na operação principal
                        const mainOpTime = parseFloat(currentOp.timeCentesimal) || 0;
                        const totalTime = accumulatedTime + mainOpTime;

                        // Atualiza a descrição para incluir o histórico (opcional, mas recomendado)
                        // Descrição Final = Descrições Acumuladas + Descrição Principal
                        const finalDescription = [...accumulatedDescriptions, currentOp.description].join(' / ');

                        const combinedOp = {
                            ...currentOp,
                            description: finalDescription,
                            timeCentesimal: totalTime.toFixed(3),
                            timeSeconds: (totalTime * 60).toFixed(3),
                            // Mantém operadoresReal da principal
                            isGrouped: true,
                            originalOps: [...accumulatedOps, currentOp]
                        };
                        processedOps.push(combinedOp);

                        // Reseta acumuladores
                        accumulatedTime = 0;
                        accumulatedDescriptions = [];
                        accumulatedOps = [];
                    } else {
                        // Operação independente normal
                        processedOps.push(currentOp);
                    }
                }
            }

            // Caso existam sub-operações "órfãs" no final do arquivo (sem operação principal depois)
            if (accumulatedOps.length > 0) {
                console.warn("Sub-operações órfãs encontradas no final do arquivo:", accumulatedOps);
            }

            return { ...data, operations: processedOps };
        };

        const saveExtractedData = async (data) => {
             if (!data.operations || data.operations.length === 0) {
                 ui.fileStatus.innerHTML = `<span class="text-orange-500 font-semibold">Nenhuma operação foi encontrada no arquivo.</span>`;
                 ui.processFileBtn.disabled = false;
                 return;
             }

            // CORRIGIDO: Lógica para criar nome único
            const originalModelName = data.modelInfo.model.trim();
            let finalModelName = originalModelName;
            let counter = 1;
            while (allProcessesMap.has(finalModelName)) {
                finalModelName = `${originalModelName} (${counter})`;
                counter++;
            }

            if (finalModelName !== originalModelName) {
                showCustomAlert(`Um balanceamento com o nome "${originalModelName}" já existe. Ele será salvo como "${finalModelName}".`, "Aviso de Renomeação");
            }
            data.modelInfo.model = finalModelName;


            const modelInfo = {
                ...data.modelInfo,
                ownerUid: currentUser.id,
                ownerEmail: currentUser.username,
                brand: data.modelInfo.brand || 'Não Identificada',
                hasLayoutPdf: false, // CORRIGIDO: Inicia o checklist zerado
                hasProcessPdf: false,
                creationDate: Date.now()
            };

            const operationsToSave = data.operations.map(op => {
                const sanitizedModelName = getSanitizedModelName(modelInfo.model);
                const uniqueOperationId = `${sanitizedModelName}-${op.sequence}`;

                const originalOpsWithIds = op.originalOps?.map(origOp => ({
                    ...origOp,
                    operationId: `${sanitizedModelName}-${origOp.sequence}`
                }));

                return {
                    ...op,
                    operationId: uniqueOperationId,
                    model: modelInfo.model, // Garante que o campo 'model' de alto nível é salvo
                    modelInfo: modelInfo,
                    status: 'pendente',
                    observation: '',
                    assignedOperators: [],
                    isGrouped: op.isGrouped || false,
                    originalOps: originalOpsWithIds || null,
                    layoutPosition: null,
                    sequence: parseInt(op.sequence, 10),
                    timeCentesimal: parseFloat(op.timeCentesimal),
                    timeSeconds: parseFloat(op.timeSeconds),
                    operatorsReal: parseInt(op.operatorsReal, 10)
                };
            });

            ui.fileStatus.innerHTML = `<div class="flex items-center justify-center gap-2 text-blue-600"><div class="loader !w-5 !h-5 !border-2"></div>Salvando ${operationsToSave.length} operações...</div>`;

            const response = await apiRequest(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'saveProcess', operations: operationsToSave })
            });

            if (response.status === 'success') {
                ui.fileStatus.innerHTML = `<span class="text-green-600 font-bold">Sucesso! Balanceamento salvo.</span>`;
                ui.celulaInput.value = '';
                ui.csvUpload.value = '';
                ui.processFileBtn.disabled = false;

                lastProcessedOperations = operationsToSave;
                renderOperationsList(lastProcessedOperations);
                renderProcessesPage();
            } else {
                ui.fileStatus.innerHTML = `<span class="text-red-500 font-semibold" title="${response.message}">Falha ao salvar. Verifique o console para detalhes.</span>`;
                ui.processFileBtn.disabled = false;
            }
        };

        const calculateEfficiency = (operation) => {
            const timeSeconds = parseFloat(String(operation.timeSeconds).replace(',', '.'));
            const goal = parseInt(operation.modelInfo.productionGoal, 10);
            const workday = parseInt(operation.modelInfo.workdayMinutes, 10);
            const operators = parseInt(operation.operatorsReal, 10);

            if (isNaN(timeSeconds) || isNaN(goal) || isNaN(workday) || isNaN(operators) || goal === 0 || workday === 0 || operators === 0) {
                return { value: 'N/D', colorClass: 'text-slate-400', numericValue: null };
            }

            const efficiency = (timeSeconds * goal) / ((workday * 60) * operators);
            const numericValue = efficiency * 100;
            const formattedValue = numericValue.toFixed(2) + '%';

            let colorClass = 'text-amber-500';
            if (numericValue > 100) { colorClass = 'text-red-600'; }
            else if (numericValue >= 80) { colorClass = 'text-green-600'; }

            return { value: formattedValue, colorClass, numericValue: numericValue };
        };

        const calculateOverallProcessMetrics = (ops) => {
             if (!ops || ops.length === 0) {
                return { totalTime: '0.000', efficiencyPercentage: 'N/D', efficiencyValue: 0, efficiencyColor: 'text-slate-400' };
            }

            const modelInfo = ops[0].modelInfo;
            const totalTime = ops.reduce((sum, op) => sum + parseFloat(String(op.timeCentesimal).replace(',', '.') || 0), 0);
            const totalPeople = parseInt(modelInfo.totalPeople, 10);
            const goal = parseInt(modelInfo.productionGoal, 10);
            const workday = parseInt(modelInfo.workdayMinutes, 10);
            let efficiencyValue = 0;
            let efficiencyPercentage = 'N/D';
            let efficiencyColor = 'text-slate-400';

            if (!isNaN(totalTime) && !isNaN(totalPeople) && !isNaN(goal) && !isNaN(workday) && totalPeople > 0 && workday > 0) {
                const calculatedEfficiency = (totalTime * goal) / (totalPeople * workday);
                efficiencyValue = calculatedEfficiency * 100;
                efficiencyPercentage = efficiencyValue.toFixed(2) + '%';
                if (calculatedEfficiency > 1.0) { efficiencyColor = 'text-red-500'; }
                else if (calculatedEfficiency >= 0.8) { efficiencyColor = 'text-green-500'; }
                else { efficiencyColor = 'text-amber-500'; }
            }

            return { totalTime: totalTime.toFixed(3), efficiencyPercentage, efficiencyValue, efficiencyColor };
        };

        const getWorkShiftName = (workday) => {
            if (workday === 506) return 'Turno B';
            if (workday === 528) return 'Turno A';
            return workday ? `${workday} min` : 'N/A';
        };

        // --- Ações ---
        const updateProcessStatus = async (modelName, newStatus) => {
            if (!modelName) return;
            const response = await apiRequest(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'updateProcessStatus', modelName, status: newStatus })
            });

            if(response.status === 'success'){
                const updatedOps = lastProcessedOperations.map(op => ({ ...op, status: newStatus }));
                lastProcessedOperations = updatedOps;
                renderOperationsList(updatedOps);
                renderProcessesPage();
            }
        };

        const deleteProcess = async (modelName) => {
             if (!modelName) return;
            const response = await apiRequest(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'deleteProcess', modelName })
            });

            if (response.status === 'success') {
                showHomeState('welcome');
                renderProcessesPage();
            }
        };

        const toggleBrandEdit = (isEditing) => {
            ui.brandDisplay.style.display = isEditing ? 'none' : 'flex';
            ui.brandEditContainer.style.display = isEditing ? 'flex' : 'none';
        };

        const handleSaveBrand = async () => {
            const newBrand = ui.brandEditSelect.value;
            const modelName = currentProcessModelName;

            const response = await apiRequest(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'updateBrand', modelName, brand: newBrand })
            });

            if (response.status === 'success') {
                lastProcessedOperations.forEach(op => op.modelInfo.brand = newBrand);
                ui.brandDisplayText.textContent = newBrand;
                toggleBrandEdit(false);
                showCustomAlert("Marca atualizada com sucesso!", "Sucesso");
                renderProcessesPage();
            } else {
                showCustomAlert("Falha ao atualizar a marca: " + response.message, "Erro");
            }
        };

        const handleSaveObservation = async () => {
            if (!currentOperation) return;
            const text = ui.observationText.value;
            // CORRIGIDO: usa a action 'updateOperation'
            const response = await apiRequest(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'updateOperation', opId: currentOperation.operationId, field: 'observation', value: text })
            });

            if (response.status === 'success') {
                currentOperation.observation = text;
                const opInList = lastProcessedOperations.find(o => o.operationId === currentOperation.operationId);
                if(opInList) opInList.observation = text;
                ui.observationStatus.textContent = "Observação salva com sucesso!";
                ui.observationStatus.className = "text-sm mt-2 text-green-600";
                setTimeout(() => ui.observationStatus.textContent = "", 3000);
            } else {
                 ui.observationStatus.textContent = "Falha ao salvar: " + response.message;
                ui.observationStatus.className = "text-sm mt-2 text-red-600";
            }
        };

        // --- Layout ---
        const openLayoutModalForPublic = async (modelName, ops) => {
            currentProcessModelName = modelName;
            lastProcessedOperations = ops;
            layoutEditorOps = JSON.parse(JSON.stringify(lastProcessedOperations));
            layoutHasChanges = false;
            currentRotation = 0;

            if(ui.editLayoutToggle) ui.editLayoutToggle.checked = false;
            if(ui.layoutViewer) ui.layoutViewer.classList.remove('edit-mode');
            if(ui.layoutEditorSidebar) ui.layoutEditorSidebar.style.display = 'none';
            if(ui.editLayoutControls) ui.editLayoutControls.style.display = 'none';
            if(ui.saveLayoutBtn) ui.saveLayoutBtn.style.display = 'none';
            if(ui.showHeatmapToggle) ui.showHeatmapToggle.checked = false;
            if(ui.heatmapLegend) ui.heatmapLegend.style.display = 'none';
            if(ui.rotateLayoutBtn) ui.rotateLayoutBtn.style.display = 'block';

            showModal('layoutModal');

            const canvas = ui.layoutCanvas;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ui.markerContainer.innerHTML = '<svg id="flow-line-svg" width="100%" height="100%"></svg>';

            const sanitizedModelName = getSanitizedModelName(currentProcessModelName);
            const url = `layouts/${sanitizedModelName}.pdf`;
            const checkFile = await fetch(url, { method: 'HEAD' });

            if (checkFile.ok) {
                ui.layoutViewer.style.display = 'block';
                ui.layoutPlaceholder.style.display = 'none';
                await renderLayout(url);
            } else {
                showCustomAlert("O arquivo de layout para este balanceamento não foi encontrado.");
                showModal('layoutModal', false);
            }
        };

        const openLayoutModal = async () => {
            if (!currentProcessModelName) {
                showCustomAlert("Nenhum balanceamento selecionado para gerir o layout.");
                return;
            }

            layoutEditorOps = JSON.parse(JSON.stringify(lastProcessedOperations));
            layoutHasChanges = false;
            currentRotation = 0;

            ui.layoutModalTitle.textContent = `Layout da Célula: ${currentProcessModelName}`;
            showModal('layoutModal');
            const canvas = ui.layoutCanvas;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ui.markerContainer.innerHTML = '<svg id="flow-line-svg" width="100%" height="100%"></svg>';

            ui.editLayoutToggle.checked = false;
            ui.showFlowToggle.checked = true;
            ui.showHeatmapToggle.checked = false;
            ui.layoutViewer.classList.remove('edit-mode');
            ui.layoutEditorSidebar.style.display = 'none';
            ui.saveLayoutBtn.style.display = 'none';
            ui.showFlowToggle.parentElement.style.display = 'flex';
            ui.heatmapLegend.style.display = 'none';
            if(ui.rotateLayoutBtn) ui.rotateLayoutBtn.style.display = 'block';

            const sanitizedModelName = getSanitizedModelName(currentProcessModelName);
            const url = `layouts/${sanitizedModelName}.pdf`;

            const checkFile = await fetch(url, { method: 'HEAD' });

            if (checkFile.ok) {
                currentLayoutUrl = url;
                ui.layoutViewer.style.display = 'block';
                ui.layoutPlaceholder.style.display = 'none';
                await renderLayout(currentLayoutUrl);
            } else {
                currentLayoutUrl = null;
                ui.layoutViewer.style.display = 'none';
                ui.layoutPlaceholder.style.display = 'flex';
            }

            renderUnplacedOperationsList();
            updateUIForPermissions();
            lucide.createIcons();
        };

        const renderLayout = async (pdfUrl) => {
            const canvas = ui.layoutCanvas;
            const ctx = canvas.getContext('2d');
            const container = ui.layoutMainContainer;

            try {
                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);

                const containerWidth = container.clientWidth - 32;
                const containerHeight = container.clientHeight - 32;
                const viewportRotated = page.getViewport({ scale: 1.0, rotation: currentRotation });
                const scaleX = containerWidth / viewportRotated.width;
                const scaleY = containerHeight / viewportRotated.height;
                const scale = Math.min(scaleX, scaleY);
                const viewport = page.getViewport({ scale: scale, rotation: currentRotation });

                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.marginLeft = viewport.width < containerWidth ? `${(containerWidth - viewport.width) / 2}px` : '0px';
                canvas.style.marginTop = viewport.height < containerHeight ? `${(containerHeight - viewport.height) / 2}px` : '0px';

                const renderContext = { canvasContext: ctx, viewport: viewport };
                await page.render(renderContext).promise;
                renderMarkers(ui.showHeatmapToggle.checked);
            } catch (error) {
                console.error("Erro ao renderizar layout PDF:", error);
                showCustomAlert("Falha ao carregar o arquivo de layout. O arquivo pode estar corrompido ou indisponível.");
                 ui.layoutViewer.style.display = 'none';
                 ui.layoutPlaceholder.style.display = 'flex';
            }
        };

        const renderMarkers = (showHeatmap = false) => {
             const markerContainer = ui.markerContainer;
            markerContainer.innerHTML = '<svg id="flow-line-svg" width="100%" height="100%"></svg>';

            layoutEditorOps.forEach(op => {
                if (op.layoutPosition && typeof op.layoutPosition.x === 'number' && typeof op.layoutPosition.y === 'number') {
                    const marker = document.createElement('div');
                    marker.className = 'op-marker';
                    marker.style.left = `${op.layoutPosition.x * 100}%`;
                    marker.style.top = `${op.layoutPosition.y * 100}%`;
                    marker.dataset.opId = op.operationId;
                    let markerColor = 'rgba(107, 114, 128, 0.8)';
                    let markerSize = '32px';

                    if (showHeatmap) {
                        const { numericValue } = calculateEfficiency(op);
                        if (numericValue === null) {
                            markerColor = 'rgba(156, 163, 175, 0.8)';
                            markerSize = '32px';
                        } else if (numericValue > 100) {
                            markerColor = 'rgba(239, 68, 68, 0.9)';
                            markerSize = '44px';
                        } else if (numericValue >= 80) {
                            markerColor = 'rgba(34, 197, 94, 0.8)';
                            markerSize = '32px';
                        } else {
                            markerColor = 'rgba(245, 158, 11, 0.9)';
                            markerSize = '36px';
                        }
                    } else {
                         markerColor = 'rgba(59, 130, 246, 0.8)';
                         markerSize = '32px';
                    }

                    marker.style.backgroundColor = markerColor;
                    marker.style.width = markerSize;
                    marker.style.height = markerSize;
                    marker.innerHTML = `
                        ${op.sequence}
                        <div class="remove-marker-btn" title="Remover Marcador">
                            <i data-lucide="x" class="w-4 h-4 pointer-events-none"></i>
                        </div>
                    `;
                    markerContainer.appendChild(marker);
                }
            });
            renderFlowLines(showHeatmap);
            lucide.createIcons();
        };

        const renderFlowLines = (showHeatmap = false) => {
             const svg = document.getElementById('flow-line-svg');
            const markerContainer = ui.markerContainer;
            if (!svg || !markerContainer) return;
            svg.innerHTML = '';
            if (showHeatmap || !ui.showFlowToggle.checked) return;

            const placedOps = layoutEditorOps
                .filter(op => op.layoutPosition && typeof op.layoutPosition.x === 'number' && typeof op.layoutPosition.y === 'number')
                .sort((a, b) => parseInt(a.sequence) - parseInt(b.sequence));

            if (placedOps.length < 2) return;
            const containerWidth = markerContainer.clientWidth;
            const containerHeight = markerContainer.clientHeight;
            const points = placedOps.map(op => `${op.layoutPosition.x * containerWidth},${op.layoutPosition.y * containerHeight}`).join(' ');
            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('points', points);
            polyline.setAttribute('class', 'flow-line');
            svg.appendChild(polyline);
        };

        const renderUnplacedOperationsList = () => {
            ui.unplacedOpsList.innerHTML = '';
            const unplacedOps = layoutEditorOps
                .filter(op => !op.layoutPosition)
                .sort((a, b) => parseInt(a.sequence) - parseInt(b.sequence));

            if (unplacedOps.length === 0) {
                ui.unplacedOpsList.innerHTML = '<p class="text-slate-500 italic text-center p-2">Todas as operações foram posicionadas.</p>';
            } else {
                unplacedOps.forEach(op => {
                    const item = document.createElement('div');
                    item.className = 'op-item flex items-center justify-between p-2.5 border bg-white rounded-md cursor-pointer hover:bg-slate-100 transition-colors';
                    item.innerHTML = `
                        <span class="font-bold text-red-600 w-8 text-center">${op.sequence}</span>
                        <span class="flex-1 pl-3 text-slate-700 truncate">${op.description}</span>
                    `;
                    item.dataset.opId = op.operationId;
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.op-item').forEach(el => el.classList.remove('selected-for-placement'));
                        item.classList.add('selected-for-placement');
                        selectedOpToPlace = op.operationId;
                    });
                    ui.unplacedOpsList.appendChild(item);
                });
            }
        };

        const handleMarkerPlacement = (event) => {
            if (!selectedOpToPlace) {
                showCustomAlert("Selecione uma operação da lista para posicionar.");
                return;
            }
            const container = ui.layoutViewer;
            const rect = container.getBoundingClientRect();
            const x = (event.clientX - rect.left) / rect.width;
            const y = (event.clientY - rect.top) / rect.height;
            const op = layoutEditorOps.find(op => op.operationId === selectedOpToPlace);
            if (!op) return;
            op.layoutPosition = { x, y };
            layoutHasChanges = true;
            renderUnplacedOperationsList();
            renderMarkers(ui.showHeatmapToggle.checked);
            selectedOpToPlace = null;
        };

        const handleSaveLayout = async () => {
             const opsToSave = layoutEditorOps.map(op => ({
                operationId: op.operationId,
                layoutPosition: op.layoutPosition
            }));

            ui.saveLayoutBtn.innerHTML = '<div class="loader !w-4 !h-4 !border-2"></div>';
            ui.saveLayoutBtn.disabled = true;

            const response = await apiRequest(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'saveLayoutPositions', operations: opsToSave })
            });

            ui.saveLayoutBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Salvar';
            ui.saveLayoutBtn.disabled = false;
            lucide.createIcons();

            if (response.status === 'success') {
                lastProcessedOperations = JSON.parse(JSON.stringify(layoutEditorOps));
                layoutHasChanges = false;
                showCustomAlert("Layout salvo com sucesso!", "Sucesso");
                 renderProcessHeader(lastProcessedOperations[0].modelInfo, calculateOverallProcessMetrics(lastProcessedOperations), lastProcessedOperations);
            } else {
                showCustomAlert("Falha ao salvar o layout: " + response.message, "Erro");
            }
        };

        const handleRemoveMarker = (opId) => {
             deleteContext = {
                type: 'marker',
                id: opId,
                name: `marcador da operação ${opId.split('-').pop()}`
            };
            ui.deleteModalTitle.textContent = `Confirmar Remoção`;
            ui.deleteModalText.textContent = `Tem certeza que deseja remover o ${deleteContext.name} do layout? (Isso não será salvo até você clicar em "Salvar").`;
            ui.confirmDeleteBtn.textContent = 'Remover';
            showModal('deleteConfirmModal');
        };

        const showOperationTooltip = (marker, event) => {
            const opId = marker.dataset.opId;
            const op = layoutEditorOps.find(op => op.operationId === opId);
            if (!op) return;
            const { value, colorClass } = calculateEfficiency(op);
            const operators = (op.assignedOperators && op.assignedOperators.length > 0)
                ? op.assignedOperators.map(o => `${o.name} (Ranking: ${o.ranking || 'N/D'})`).join(', ')
                : 'Nenhum operador';

            ui.operationTooltip.innerHTML = `
                <div class="font-bold text-base">${op.sequence} - ${op.description}</div>
                <div class="mt-2 pt-2 border-t border-slate-700">
                    <div class="text-xs text-slate-300">Eficiência: <span class="${colorClass} font-bold">${value}</span></div>
                    <div class="text-xs text-slate-300">Operadores: <span class="font-semibold text-white">${operators}</span></div>
                </div>
            `;
            ui.operationTooltip.style.display = 'block';
            const tooltipRect = ui.operationTooltip.getBoundingClientRect();
            let left = event.clientX + 15;
            let top = event.clientY + 15;
            if (left + tooltipRect.width > window.innerWidth) {
                left = event.clientX - tooltipRect.width - 15;
            }
            if (top + tooltipRect.height > window.innerHeight) {
                top = event.clientY - tooltipRect.height - 15;
            }
            ui.operationTooltip.style.left = `${left}px`;
            ui.operationTooltip.style.top = `${top}px`;
        };

        // --- Funções de Modais ---
        const openDeleteModal = (type, id, name, onConfirmCallback) => {
             deleteContext = { type, id, name, onConfirm: onConfirmCallback };
            ui.deleteModalTitle.textContent = `Confirmar Ação`;
            ui.deleteModalText.textContent = `Tem certeza que deseja ${type === 'marker' ? 'remover' : (type === 'unsaved' ? '' : 'excluir')} ${name}?`;
            if (type === 'unsaved') ui.deleteModalText.textContent = `Você possui alterações não salvas no layout. Deseja fechar mesmo assim?`;
            ui.confirmDeleteBtn.textContent = 'Confirmar';
            if (type === 'marker') ui.confirmDeleteBtn.textContent = 'Remover';
            if (type === 'unsaved') ui.confirmDeleteBtn.textContent = 'Fechar';
            showModal('deleteConfirmModal');
        };

        const confirmDelete = async () => {
            const { type, id, onConfirm } = deleteContext;
            let response = null;

            if (onConfirm) {
                onConfirm();
            } else if (type === 'processo') {
                response = await apiRequest(API_URL, {
                    method: 'POST', body: JSON.stringify({ action: 'deleteProcess', modelName: id })
                });
                if(response.status === 'success') {
                    showHomeState('welcome');
                    renderProcessesPage();
                }
            } else if (type === 'usuário') {
                 response = await apiRequest(API_URL, {
                    method: 'POST', body: JSON.stringify({ action: 'deleteUser', id: id })
                });
                if(response.status === 'success') renderAdminPage();
            } else if (type === 'marker') {
                const op = layoutEditorOps.find(op => op.operationId === id);
                if (op) op.layoutPosition = null;
                layoutHasChanges = true;
                renderMarkers(ui.showHeatmapToggle.checked);
                renderUnplacedOperationsList();
            } else if (type === 'removeAllMarkers') {
                layoutEditorOps.forEach(op => op.layoutPosition = null);
                layoutHasChanges = true;
                renderMarkers(ui.showHeatmapToggle.checked);
                renderUnplacedOperationsList();
            }

            showModal('deleteConfirmModal', false);
            deleteContext = { type: null, id: null, name: null, onConfirm: null };
        };

        const handleRemoveAllMarkers = async () => {
            deleteContext = { type: 'removeAllMarkers', id: null, name: 'todos os marcadores' };
            ui.deleteModalTitle.textContent = 'Confirmar Remoção em Massa';
            ui.deleteModalText.textContent = `Tem certeza que deseja remover todos os marcadores do layout? (Isso não será salvo até você clicar em "Salvar").`;
            ui.confirmDeleteBtn.textContent = 'Remover Todos';
            showModal('deleteConfirmModal');
        };

        const openManageTeamModal = (operation) => {
            if (!operation) return;
            currentOperation = operation;
            ui.manageTeamModalOpInfo.textContent = `ID: ${operation.operationId.split('-').pop()} - ${operation.description}`;
            renderTeamInModal();
            showModal('manageTeamModal');
            ui.addOperatorByBadgeInput.focus();
        };

        const openBatchTeamManagementModal = async () => {
             const processName = lastProcessedOperations.length > 0 ? lastProcessedOperations[0].modelInfo.model : 'Balanceamento Atual';
            ui.batchModalProcessInfo.textContent = `Gerenciando equipes para: ${processName}`;
            batchTeamOps = lastProcessedOperations.sort((a,b) => parseInt(a.sequence) - parseInt(b.sequence));
            if (batchTeamOps.length > 0) {
                batchTeamIndex = 0;
                renderBatchTeamOperation();
                showModal('batchTeamModal');
                ui.batchAddOperatorInput.focus();
            } else {
                showCustomAlert("Nenhuma operação encontrada para este balanceamento.", "Aviso");
            }
        };

        const renderBatchTeamOperation = () => {
            const op = batchTeamOps[batchTeamIndex];
            if (!op) {
                showModal('batchTeamModal', false);
                showCustomAlert("Todas as operações foram gerenciadas!", "Sucesso");
                renderOperationsList(lastProcessedOperations);
                return;
            }

            ui.batchOpSequence.textContent = `Sequência: ${op.sequence}`;
            ui.batchOpDescription.textContent = op.description;
            ui.batchOpRequired.textContent = op.operatorsReal;
            const assignedCount = op.assignedOperators ? op.assignedOperators.length : 0;
            ui.batchOpCurrent.textContent = assignedCount;
            renderTeamInBatchModal(op);
            ui.batchPreviousBtn.disabled = batchTeamIndex === 0;
            ui.batchNextBtn.style.display = batchTeamIndex < batchTeamOps.length - 1 ? 'flex' : 'none';
            ui.batchSkipBtn.style.display = batchTeamIndex < batchTeamOps.length - 1 ? 'flex' : 'none';
            ui.batchFinishBtn.style.display = batchTeamIndex === batchTeamOps.length - 1 ? 'flex' : 'none';
        };

        const renderTeamInBatchModal = (op) => {
            const listContainer = ui.batchTeamList;
            listContainer.innerHTML = '';
            const assigned = op.assignedOperators || [];
            if (assigned.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-slate-500 italic">Nenhum operador vinculado.</p>';
            } else {
                assigned.forEach(operator => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between bg-slate-100 p-2 rounded-md';
                    el.innerHTML = `
                        <span class="text-sm font-medium text-slate-800">${operator.name} (${operator.badgeId})</span>
                        <button data-badge-id="${operator.badgeId}" class="batch-remove-operator-btn p-1 text-red-500 hover:bg-red-100 rounded-full">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>`;
                    listContainer.appendChild(el);
                });
                document.querySelectorAll('.batch-remove-operator-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => removeOperatorFromBatchTeam(e.currentTarget.dataset.badgeId));
                });
            }
            lucide.createIcons();
        };

        const confirmJustificationAndAddOperator = async () => {
             const { badgeId, op, isBatch, reason } = justificationContext;
            const statusEl = isBatch ? ui.batchAddOperatorStatus : ui.addOperatorStatus;

            const operatorResponse = await apiRequest(`${API_URL}?action=getOperators&badgeId=${badgeId}`);
            if (operatorResponse.status !== 'success' || operatorResponse.data.length === 0) {
                 statusEl.textContent = 'Operador não encontrado.';
                 statusEl.className = 'text-sm mt-2 text-red-600';
                 return;
            }

            const operatorData = operatorResponse.data[0];
            const newOperator = {
                name: operatorData.name,
                badgeId: operatorData.badgeId,
                ranking: null,
                justification: reason
            };
            const updatedOperators = [...(op.assignedOperators || []), newOperator];
            const response = await apiRequest(API_URL, {
                method: 'POST', body: JSON.stringify({ action: 'updateOperation', opId: op.operationId, field: 'assignedOperators', value: updatedOperators })
            });

            if(response.status === 'success'){
                 op.assignedOperators = updatedOperators;
                 if (isBatch) {
                    renderBatchTeamOperation();
                } else {
                    const opInMainList = lastProcessedOperations.find(o => o.operationId === currentOperation.operationId);
                    if (opInMainList) opInMainList.assignedOperators = updatedOperators;
                    renderTeamInModal();
                }
                statusEl.textContent = `${operatorData.name} adicionado com justificativa!`;
                statusEl.className = 'text-sm mt-2 text-green-600';
            } else {
                statusEl.textContent = 'Falha ao adicionar operador: ' + response.message;
                statusEl.className = 'text-sm mt-2 text-red-600';
            }
            showModal('overstaffJustificationModal', false);
            justificationContext = { badgeId: null, op: null, isBatch: false, reason: '' };
            ui.overstaffReasonInput.value = '';
        };

        const addOperatorToTeamByBadge = async (e) => {
            const badgeId = e.target.value.trim();
            const statusEl = ui.addOperatorStatus;
            if (!badgeId) return;

            const required = parseInt(currentOperation.operatorsReal, 10);
            const assigned = currentOperation.assignedOperators?.length || 0;
            if (assigned >= required) {
                justificationContext = { badgeId: badgeId, op: currentOperation, isBatch: false };
                showModal('overstaffJustificationModal');
                e.target.value = '';
                return;
            }

            statusEl.textContent = 'Buscando...';
            statusEl.className = 'text-sm mt-2 text-slate-500';

            const assignedIds = (currentOperation.assignedOperators || []).map(o => o.badgeId);
            if (assignedIds.includes(badgeId)) {
                statusEl.textContent = 'Operador já está na equipe.';
                statusEl.className = 'text-sm mt-2 text-amber-600';
                e.target.value = '';
                return;
            }

            const operatorResponse = await apiRequest(`${API_URL}?action=getOperators&badgeId=${badgeId}`);
            if (operatorResponse.status === 'success' && operatorResponse.data.length > 0) {
                 const operatorData = operatorResponse.data[0];
                 const newOperator = { name: operatorData.name, badgeId: operatorData.badgeId, ranking: null };
                 const updatedOperators = [...(currentOperation.assignedOperators || []), newOperator];
                 // CORRIGIDO: usa a action 'updateOperation'
                 const updateResponse = await apiRequest(API_URL, {
                    method: 'POST', body: JSON.stringify({ action: 'updateOperation', opId: currentOperation.operationId, field: 'assignedOperators', value: updatedOperators })
                 });

                 if (updateResponse.status === 'success') {
                    currentOperation.assignedOperators = updatedOperators;
                    const opInMainList = lastProcessedOperations.find(op => op.operationId === currentOperation.operationId);
                    if (opInMainList) opInMainList.assignedOperators = updatedOperators;

                    renderTeamInModal();
                    statusEl.textContent = `${operatorData.name} adicionado com sucesso!`;
                    statusEl.className = 'text-sm mt-2 text-green-600';
                 } else {
                    statusEl.textContent = 'Falha ao adicionar operador: ' + updateResponse.message;
                    statusEl.className = 'text-sm mt-2 text-red-600';
                 }

            } else {
                statusEl.textContent = 'Operador não encontrado.';
                statusEl.className = 'text-sm mt-2 text-red-600';
            }
            e.target.value = '';
        };

        const addOperatorToBatchTeam = async (e) => {
            const badgeId = e.target.value.trim();
            const statusEl = ui.batchAddOperatorStatus;
            const op = batchTeamOps[batchTeamIndex];
            if (!badgeId || !op) return;

            const required = parseInt(op.operatorsReal, 10);
            const assigned = op.assignedOperators?.length || 0;
            if (assigned >= required) {
                justificationContext = { badgeId: badgeId, op: op, isBatch: true };
                showModal('overstaffJustificationModal');
                e.target.value = '';
                return;
            }

            statusEl.textContent = 'Buscando...';
            statusEl.className = 'text-sm mt-2 text-slate-500';

            const assignedIds = (op.assignedOperators || []).map(o => o.badgeId);
            if (assignedIds.includes(badgeId)) {
                statusEl.textContent = 'Operador já está na equipe.';
                statusEl.className = 'text-sm mt-2 text-amber-600';
                e.target.value = '';
                return;
            }

            const operatorResponse = await apiRequest(`${API_URL}?action=getOperators&badgeId=${badgeId}`);
            if (operatorResponse.status === 'success' && operatorResponse.data.length > 0) {
                 const operatorData = operatorResponse.data[0];
                 const newOperator = { name: operatorData.name, badgeId: operatorData.badgeId, ranking: null };
                 const updatedOperators = [...(op.assignedOperators || []), newOperator];
                 // CORRIGIDO: usa a action 'updateOperation'
                 const updateResponse = await apiRequest(API_URL, {
                    method: 'POST', body: JSON.stringify({ action: 'updateOperation', opId: op.operationId, field: 'assignedOperators', value: updatedOperators })
                 });

                if (updateResponse.status === 'success') {
                    op.assignedOperators = updatedOperators;
                    renderBatchTeamOperation();
                    statusEl.textContent = `${operatorData.name} adicionado!`;
                    statusEl.className = 'text-sm mt-2 text-green-600';
                } else {
                    statusEl.textContent = 'Falha ao adicionar operador: ' + updateResponse.message;
                    statusEl.className = 'text-sm mt-2 text-red-600';
                }
            } else {
                 statusEl.textContent = 'Operador não encontrado.';
                 statusEl.className = 'text-sm mt-2 text-red-600';
            }
            e.target.value = '';
        };

        const removeOperatorFromTeam = async (badgeId) => {
             const updatedOperators = currentOperation.assignedOperators.filter(op => op.badgeId !== badgeId);
            // CORRIGIDO: usa a action 'updateOperation'
            const response = await apiRequest(API_URL, {
                method: 'POST', body: JSON.stringify({ action: 'updateOperation', opId: currentOperation.operationId, field: 'assignedOperators', value: updatedOperators })
            });

            if (response.status === 'success') {
                currentOperation.assignedOperators = updatedOperators;
                const opInMainList = lastProcessedOperations.find(op => op.operationId === currentOperation.operationId);
                if (opInMainList) opInMainList.assignedOperators = updatedOperators;
                renderTeamInModal();
            } else {
                 showCustomAlert("Falha ao remover operador: " + response.message, "Erro");
            }
        };

        const removeOperatorFromBatchTeam = async (badgeId) => {
            const op = batchTeamOps[batchTeamIndex];
            if (!op) return;
            const updatedOperators = op.assignedOperators.filter(operator => operator.badgeId !== badgeId);
            // CORRIGIDO: usa a action 'updateOperation'
            const response = await apiRequest(API_URL, {
                method: 'POST', body: JSON.stringify({ action: 'updateOperation', opId: op.operationId, field: 'assignedOperators', value: updatedOperators })
            });

            if (response.status === 'success') {
                 op.assignedOperators = updatedOperators;
                 renderBatchTeamOperation();
            } else {
                showCustomAlert("Falha ao remover operador: " + response.message, "Erro");
            }
        };

        const handleUpdateOperatorRanking = async (badgeId, newRanking) => {
            if (!currentOperation) return;
            const op = lastProcessedOperations.find(o => o.operationId === currentOperation.operationId);
            if (!op) return;

            const updatedOperators = op.assignedOperators.map(operator => {
                if (operator.badgeId === badgeId) {
                    return { ...operator, ranking: newRanking };
                }
                return operator;
            });
            // CORRIGIDO: usa a action 'updateOperation'
            const response = await apiRequest(API_URL, {
                method: 'POST', body: JSON.stringify({ action: 'updateOperation', opId: op.operationId, field: 'assignedOperators', value: updatedOperators })
            });

            if(response.status === 'success') {
                op.assignedOperators = updatedOperators;
                renderTeamInModal();
            } else {
                showCustomAlert("Falha ao atualizar ranking: " + response.message, "Erro");
            }
        }

        const renderTeamInModal = () => {
            const assigned = currentOperation.assignedOperators || [];
            const required = parseInt(currentOperation.operatorsReal) || 0;
            ui.manageTeamCountStatus.textContent = `Operadores Vinculados: ${assigned.length} de ${required}`;
            ui.manageTeamList.innerHTML = '';

            if (assigned.length === 0) {
                ui.manageTeamList.innerHTML = '<p class="text-sm text-slate-500 italic">Nenhum operador vinculado.</p>';
            } else {
                assigned.forEach(op => {
                    const el = document.createElement('div');
                    el.className = 'flex flex-col sm:flex-row sm:items-center justify-between bg-slate-100 p-2 rounded-md space-y-2 sm:space-y-0';
                    el.innerHTML = `
                        <div class="flex-1">
                            <span class="text-sm font-medium text-slate-800">${op.name} (${op.badgeId})</span>
                        </div>
                        <div class="flex items-center gap-2">
                             <label class="text-sm text-slate-600">Ranking:</label>
                             <input type="number" min="1" max="10" value="${op.ranking || ''}" data-badge-id="${op.badgeId}" class="ranking-input w-16 p-1 border border-slate-300 rounded-md text-sm text-center">
                             <button data-badge-id="${op.badgeId}" class="remove-operator-btn p-1 text-red-500 hover:bg-red-100 rounded-full">
                                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                             </button>
                        </div>`;
                    ui.manageTeamList.appendChild(el);
                });
                document.querySelectorAll('.remove-operator-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => removeOperatorFromTeam(e.currentTarget.dataset.badgeId));
                });
                document.querySelectorAll('.ranking-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const badgeId = e.target.dataset.badgeId;
                        const newRanking = parseInt(e.target.value, 10);
                        if (!isNaN(newRanking) && newRanking >= 1 && newRanking <= 10) {
                            handleUpdateOperatorRanking(badgeId, newRanking);
                        } else if (e.target.value === '') {
                             handleUpdateOperatorRanking(badgeId, null);
                        }
                    });
                });
                lucide.createIcons();
            }
        };

        const openEditUserModal = (user) => {
            editingUserId = user.id;
            ui.editUserName.value = user.name;
            ui.editUserEmail.value = user.username;
            ui.editUserRole.value = user.role;
            ui.editUserStatus.textContent = '';
            showModal('editUserModal');
        };

        const handleEditUser = async (e) => {
            e.preventDefault();
            const newName = ui.editUserName.value;
            const newRole = ui.editUserRole.value;
            const statusEl = ui.editUserStatus;

            statusEl.textContent = 'Salvando...';
            statusEl.className = 'text-sm text-center text-slate-500';

            const response = await apiRequest(API_URL, {
                method: 'POST', body: JSON.stringify({ action: 'updateUser', id: editingUserId, name: newName, role: newRole })
            });

            if (response.status === 'success') {
                statusEl.textContent = 'Usuário atualizado!';
                statusEl.className = 'text-sm text-center text-green-600';
                renderAdminPage();
                setTimeout(() => showModal('editUserModal', false), 1000);
            } else {
                 statusEl.textContent = 'Falha ao salvar: ' + response.message;
                 statusEl.className = 'text-sm text-center text-red-600';
            }
        };

        // --- Páginas Específicas ---
        const renderAdminPage = async () => {
            ui.usersListLoader.style.display = 'block';
            ui.usersListBody.innerHTML = '';
            const response = await apiRequest(`${API_URL}?action=getUsers`);
            ui.usersListLoader.style.display = 'none';

            if (response.status === 'success') {
                response.data.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm font-medium text-slate-800 whitespace-nowrap">${user.name}</td>
                        <td class="px-4 py-3 text-sm text-slate-600 whitespace-nowrap">${user.username}</td>
                        <td class="px-4 py-3 text-sm text-slate-600 capitalize">${user.role}</td>
                        <td class="px-4 py-3">
                            <div class="flex gap-2">
                                <button data-user-json='${JSON.stringify(user)}' class="edit-user-btn p-2 text-slate-600 hover:bg-slate-200 rounded-full">
                                    <i data-lucide="edit" class="w-5 h-5"></i>
                                </button>
                                <button data-id="${user.id}" data-name="${user.name}" class="delete-user-btn p-2 text-red-500 hover:bg-red-100 rounded-full">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </td>`;
                    ui.usersListBody.appendChild(row);
                });
                document.querySelectorAll('.edit-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => openEditUserModal(JSON.parse(e.currentTarget.dataset.userJson)));
                });
                document.querySelectorAll('.delete-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const { id, name } = e.currentTarget.dataset;
                        openDeleteModal('usuário', id, name);
                    });
                });
            } else {
                ui.usersListBody.innerHTML = '<tr><td colspan="4" class="text-red-500 text-center p-4">Falha ao carregar dados.</td></tr>';
            }
            lucide.createIcons();
        };

        const handleCreateUser = async (e) => {
            e.preventDefault();
            const name = ui.newUserName.value;
            const username = ui.newUserEmail.value;
            const password = ui.newUserPassword.value;
            const role = ui.newUserRole.value;
            const statusEl = ui.createUserStatus;

            statusEl.textContent = 'Criando...';
            statusEl.className = 'text-sm text-center text-slate-500';

            const response = await apiRequest(API_URL, {
                method: 'POST', body: JSON.stringify({ action: 'createUser', name, username, password, role })
            });

            if (response.status === 'success') {
                statusEl.textContent = 'Usuário criado com sucesso!';
                statusEl.className = 'text-sm text-center text-green-600';
                ui.createUserForm.reset();
                renderAdminPage();
            } else {
                statusEl.textContent = response.message || 'Falha ao criar usuário.';
                statusEl.className = 'text-sm text-center text-red-600';
            }
        };

        // --- Event Listeners ---
        const addEventListeners = () => {
            ui.loginForm.addEventListener('submit', handleLogin);
            ui.logoutBtn.addEventListener('click', handleLogout);
            ui.publicAccessBtn.addEventListener('click', () => {
                showView('publicView');
                renderPublicContent();
            });
            ui.goToLoginBtn.addEventListener('click', () => showView('loginPage'));

            ui.mobileMenuBtn.addEventListener('click', () => {
                ui.sidebar.classList.toggle('-translate-x-full');
            });
            ui.navHome.addEventListener('click', () => showPage('pageHome'));
            ui.navAnalytics.addEventListener('click', () => showPage('pageAnalytics'));
            ui.navProcesses.addEventListener('click', () => showPage('pageProcesses'));
            ui.navAdmin.addEventListener('click', () => showPage('pageAdmin'));

            ui.processesSearchInput?.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredMap = new Map();
                allProcessesMap.forEach((ops, modelName) => {
                    const op = ops[0];
                    if (modelName.toLowerCase().includes(searchTerm) ||
                        (op.modelInfo.celula && op.modelInfo.celula.toLowerCase().includes(searchTerm))) {
                        filteredMap.set(modelName, ops);
                    }
                });
                renderProcessCards(filteredMap);
            });

            ui.processFileBtn.addEventListener('click', handleProcessFiles);
            ui.operatorBadgeConsultInput.addEventListener('change', handleOperatorBadgeSearch);
            ui.backToListBtn.addEventListener('click', () => renderOperationsList(lastProcessedOperations));
            ui.saveObservationBtn.addEventListener('click', handleSaveObservation);
            ui.manageTeamFromDetailBtn.addEventListener('click', () => openManageTeamModal(currentOperation));
            ui.manageAllTeamsBtn.addEventListener('click', openBatchTeamManagementModal);

            ui.approveProcessBtn.addEventListener('click', () => updateProcessStatus(currentProcessModelName, 'aprovado'));
            ui.rejectProcessBtn.addEventListener('click', () => updateProcessStatus(currentProcessModelName, 'reprovado'));
            ui.deleteProcessBtn.addEventListener('click', () => openDeleteModal('processo', currentProcessModelName, currentProcessModelName));

            ui.cancelDeleteBtn.addEventListener('click', () => showModal('deleteConfirmModal', false));
            ui.confirmDeleteBtn.addEventListener('click', confirmDelete);
            ui.customAlertOkBtn.addEventListener('click', () => showModal('customAlertModal', false));

            const closeTeamModal = () => {
                showModal('manageTeamModal', false);
                if (ui.resultContent.style.display === 'block') {
                    renderAssignedOperatorsForDetailView();
                } else {
                    renderOperationsList(lastProcessedOperations);
                }
            }
            ui.closeManageTeamModalBtn.addEventListener('click', closeTeamModal);
            ui.doneManageTeamBtn.addEventListener('click', closeTeamModal);
            ui.addOperatorByBadgeInput.addEventListener('change', addOperatorToTeamByBadge);

            ui.closeBatchModalBtn.addEventListener('click', () => {
                showModal('batchTeamModal', false);
                renderOperationsList(lastProcessedOperations);
            });
            ui.batchPreviousBtn.addEventListener('click', () => {
                if (batchTeamIndex > 0) {
                    batchTeamIndex--;
                    renderBatchTeamOperation();
                }
            });
            ui.batchNextBtn.addEventListener('click', () => {
                if (batchTeamIndex < batchTeamOps.length - 1) {
                    batchTeamIndex++;
                    renderBatchTeamOperation();
                }
            });
            ui.batchSkipBtn.addEventListener('click', () => {
                 if (batchTeamIndex < batchTeamOps.length - 1) {
                    batchTeamIndex++;
                    renderBatchTeamOperation();
                 } else {
                     showModal('batchTeamModal', false);
                     showCustomAlert("Você chegou ao final da lista!", "Aviso");
                 }
            });
            ui.batchFinishBtn.addEventListener('click', () => {
                showModal('batchTeamModal', false);
                showCustomAlert("Gerenciamento de equipes concluído!", "Sucesso");
                renderOperationsList(lastProcessedOperations);
            });
            ui.batchAddOperatorInput.addEventListener('change', addOperatorToBatchTeam);
            ui.cancelEditUserBtn.addEventListener('click', () => showModal('editUserModal', false));
            ui.editUserForm.addEventListener('submit', handleEditUser);
            ui.createUserForm.addEventListener('submit', handleCreateUser);
            ui.cancelOverstaffBtn.addEventListener('click', () => showModal('overstaffJustificationModal', false));
            ui.confirmOverstaffBtn.addEventListener('click', () => {
                justificationContext.reason = ui.overstaffReasonInput.value;
                if (!justificationContext.reason.trim()) {
                    showCustomAlert("Por favor, insira uma justificativa.");
                    return;
                }
                confirmJustificationAndAddOperator();
            });
        };

        const addLayoutEventListeners = () => {
            const handleFileUpload = async (file, type) => {
                if (!file || !currentProcessModelName) return;

                const statusEl = type === 'layout' ? ui.layoutUploadStatus : ui.processPdfUploadStatus;
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', type);
                formData.append('modelName', getSanitizedModelName(currentProcessModelName));

                statusEl.textContent = 'Carregando...';

                const response = await apiRequest(UPLOAD_URL, {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 'success') {
                    const flagField = type === 'layout' ? 'hasLayoutPdf' : 'hasProcessPdf';
                    if (type === 'layout') {
                        currentLayoutUrl = response.filePath;
                        ui.layoutViewer.style.display = 'block';
                        ui.layoutPlaceholder.style.display = 'none';
                        currentRotation = 0;
                        await renderLayout(currentLayoutUrl + `?v=${Date.now()}`);
                    }
                    layoutEditorOps.forEach(op => op.modelInfo[flagField] = true);
                    lastProcessedOperations = JSON.parse(JSON.stringify(layoutEditorOps));
                    renderProcessHeader(lastProcessedOperations[0].modelInfo, calculateOverallProcessMetrics(lastProcessedOperations), lastProcessedOperations);
                    layoutHasChanges = true;
                    statusEl.textContent = 'Sucesso!';
                } else {
                    statusEl.textContent = response.message || 'Erro no upload.';
                }
            };

            ui.layoutPdfUpload?.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'layout'));
            ui.processPdfUpload?.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'process'));

            ui.viewProcessPdfBtn?.addEventListener('click', () => {
                const model = layoutEditorOps[0]?.modelInfo;
                if (model && model.hasProcessPdf) {
                    const sanitizedModelName = getSanitizedModelName(model.model);
                    const url = `processes/${sanitizedModelName}.pdf`;
                    window.open(url, '_blank');
                } else {
                    showCustomAlert("Nenhum PDF de balanceamento foi carregado para este modelo.");
                }
            });

            ui.editLayoutToggle?.addEventListener('change', (e) => {
                const isEditing = e.target.checked;
                ui.layoutViewer.classList.toggle('edit-mode', isEditing);
                ui.layoutEditorSidebar.style.display = isEditing ? 'flex' : 'none';
                ui.saveLayoutBtn.style.display = isEditing ? 'flex' : 'none';
            });

            ui.saveLayoutBtn?.addEventListener('click', handleSaveLayout);
            ui.rotateLayoutBtn?.addEventListener('click', () => {
                currentRotation = (currentRotation + 90) % 360;
                if(currentLayoutUrl) {
                    renderLayout(currentLayoutUrl);
                }
            });

            ui.showFlowToggle?.addEventListener('change', (e) => {
                if(ui.showHeatmapToggle.checked) {
                    e.target.checked = false;
                    lucide.createIcons();
                    return;
                }
                renderFlowLines(false);
            });

            ui.showHeatmapToggle?.addEventListener('change', (e) => {
                const showHeatmap = e.target.checked;
                if(showHeatmap) {
                    ui.showFlowToggle.checked = false;
                }
                ui.showFlowToggle.parentElement.style.display = showHeatmap ? 'none' : 'flex';
                ui.heatmapLegend.style.display = showHeatmap ? 'flex' : 'none';
                renderMarkers(showHeatmap);
            });

            ui.removeAllMarkersBtn?.addEventListener('click', handleRemoveAllMarkers);

            ui.markerContainer.addEventListener('click', (e) => {
                if (e.target.closest('.remove-marker-btn')) {
                    const marker = e.target.closest('.op-marker');
                    if (marker && marker.dataset.opId) {
                        handleRemoveMarker(marker.dataset.opId);
                    }
                }
            });
            ui.markerContainer.addEventListener('mouseover', (e) => {
                const marker = e.target.closest('.op-marker');
                if (marker) {
                    showOperationTooltip(marker, e);
                }
            });
            ui.markerContainer.addEventListener('mouseout', (e) => {
                const marker = e.target.closest('.op-marker');
                if (marker) {
                    ui.operationTooltip.style.display = 'none';
                }
            });

            ui.layoutViewer.addEventListener('click', (e) => {
                if (ui.layoutViewer.classList.contains('edit-mode') && !e.target.closest('.op-marker')) {
                    handleMarkerPlacement(e);
                }
            });

            ui.closeLayoutModalBtn?.addEventListener('click', () => {
                if (layoutHasChanges && ui.editLayoutToggle.checked) {
                    openDeleteModal('unsaved', null, 'alterações não salvas', () => {
                        showModal('layoutModal', false);
                        renderOperationsList(lastProcessedOperations);
                    });
                } else {
                    showModal('layoutModal', false);
                    renderOperationsList(lastProcessedOperations);
                }
            });
        };

        // --- Ponto de Entrada da Aplicação ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthState();
            addEventListeners();
            addLayoutEventListeners();
            lucide.createIcons();
        });
    </script>
    </body>
</html>
